"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _unsupportedIterableToArray(e,t){var r;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(r="Object"===(r=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}Object.defineProperty(exports,"__esModule",{value:!0});var ModeType={Array:"array",Tree:"tree"},errEnum={stop:"stop",filter:"filter"},getTargetNode=function e(t,r){return!(!t||t===document)&&(t===r||e(t.parentNode,r))},dirReadEntry=function(e,t){var i=t.endFuc,a=t.excFuc,r=e.createReader();(function n(){r.readEntries(function(r){(function e(t){return r[t]||0!==t?r[t]?void a(r[t],{next:function(){e(t+1)}}):n():i()})(0)})})()},getFileExtension=function(e){var e=e instanceof File?e.name:e;return null!=(e=e.match(/\.([0-9a-z]+)(?:[\\?#]|$)/i)[1])?e:""},selectResource=function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],r=Object.assign({},1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},e?{webkitdirectory:!0}:{},{type:"file",visibility:"hidden"}),n=document.createElement("input");return Object.keys(r).forEach(function(e){var t=r[e];n.setAttribute(e,t)}),n.click(),new Promise(function(t,r){n.addEventListener("change",function(){var e;n.files&&0!=(null==(e=n.files)?void 0:e.length)?(e=Array.from(n.files),t(e)):r()})})},selectFileChange=function(e,t){return[].slice.call(e).map(function(e){return t?t(e):{file:e,fullPath:e.name,name:e.name,size:e.size,type:e.type}})},selectFolderChange=function(e,t){var r;return t===ModeType.Array?selectFileChange(e,function(e){return{file:e,fullPath:e.webkitRelativePath,name:e.name,size:e.size,type:e.type}}):(r=[],[].slice.call(e).forEach(function(i){var a=i.webkitRelativePath.split("/");a.reduce(function(e,t,r){var n=e.find(function(e){return e.name===t});return n?n.child||(n.child=[]):(n={name:t,child:[],type:"text/directory"},r===a.length-1&&(n.type=i.type,n.file=i,delete n.child),e.push(n),n.child)},r)}),depthFirstTraversal(r[0],{path:""}),r)},depthFirstTraversal=function t(r,e){var n,i=e.getSize,a=void 0===i?null:i,i=e.path,e=void 0===i?"":i;return r.child?(n=0,r.fullPath=e+r.name,r.file=new File([],r.fullPath,{type:"text/directory"}),r.child.forEach(function(e){n+=t(e,{getSize:a,path:r.fullPath+"/"})}),r.totalSize=n):(r.fullPath=e+r.name,r.size=r.file.size,a?a(r):r.size||0)},filterSize=function(e){return"number"!=typeof e?"":e<pow1024(1)?e+" B":e<pow1024(2)?(e/pow1024(1)).toFixed(2)+" KB":e<pow1024(3)?(e/pow1024(2)).toFixed(2)+" MB":e<pow1024(4)?(e/pow1024(3)).toFixed(2)+" GB":(e/pow1024(4)).toFixed(2)+" TB"},pow1024=function(e){return Math.pow(1024,e)},noop=function(){},ResHandle=function(){function t(e){_classCallCheck(this,t),this.targetDom=e.targetDom,this.dragoverFuc=e.dragoverFuc||noop,this.dragleaveFuc=e.dragleaveFuc||noop,this.beforeReadFuc=e.beforeReadFuc,this.readDataFuc=e.readDataFuc||noop,this.validFuc=e.validFuc,this.filterFuc=e.filterFuc,this.mode=e.mode||ModeType.Array,this.onlyFile=e.onlyFile||!1,this.bindFuc=null,this.targetOverFlag=!1,this.init()}return _createClass(t,[{key:"init",value:function(){this.targetDom&&(this.bindFuc={dragFuc:this.dragFuc.bind(this),getDrapFile:this.getDrapFile.bind(this),pasteFuc:this.pasteFuc.bind(this),mouseFuc:this.mouseFuc.bind(this)},this.targetDom.addEventListener("mouseenter",this.bindFuc.mouseFuc,!1),this.targetDom.addEventListener("mouseleave",this.bindFuc.mouseFuc,!1),document.addEventListener("paste",this.bindFuc.pasteFuc,!1),this.targetDom.addEventListener("dragover",this.bindFuc.dragFuc,!1),this.targetDom.addEventListener("dragleave",this.bindFuc.dragFuc,!1),this.targetDom.addEventListener("drop",this.bindFuc.getDrapFile,!1))}},{key:"destroy",value:function(){this.targetDom.removeEventListener("dragover",this.bindFuc.dragFuc,!1),this.targetDom.removeEventListener("dragleave",this.bindFuc.dragFuc,!1),this.targetDom.removeEventListener("drop",this.bindFuc.getDrapFile,!1),this.bindFuc=null}},{key:"mouseFuc",value:function(e){"mouseenter"===e.type?this.targetOverFlag=!0:this.targetOverFlag=!1}},{key:"dragFuc",value:function(e){return e.stopPropagation(),e.preventDefault(),this["dragover"===e.type?"dragoverFuc":"dragleaveFuc"].call(e.target),this}},{key:"getDrapFile",value:function(e){this.dragFuc(e),this.addDataTransfer(e.dataTransfer)}},{key:"pasteFuc",value:function(e){var t;this.targetOverFlag&&(t=document.activeElement,/textarea|input/i.test(t.nodeName)||this.addDataTransfer(e.clipboardData))}},{key:"errHanlder",value:function(e,t){(null==e?void 0:e.message)!==errEnum.stop&&t&&t()}},{key:"addDataTransfer",value:function(e){var t=this,r=!0;if((r="function"==typeof this.beforeReadFuc?this.beforeReadFuc():r)&&null!=e&&null!=(r=e.items)&&r.length){for(var n=[],i=0;i<e.items.length;i++){var a;(a=e.items[i].webkitGetAsEntry())&&n.push(a)}return this.getContent(n).then(function(e){"function"==typeof t.readDataFuc&&t.readDataFuc(e)},function(e){t.errHanlder(e)})}}},{key:"getContent",value:function(o){var u=this;return new Promise(function(i,e){var a=[];(function t(r){var e=o[r];if(!e)return i(a);var n="tree"===u.mode?"getFileSystemEntryTree":"getFileSystemEntryArray";u[n](e,"").then(function(e){a.push.apply(a,_toConsumableArray(e)),t(r+1)},function(e){u.errHanlder(e)})})(0)})}},{key:"ifPushValid",value:function(e){return"function"!=typeof this.filterFuc||this.filterFuc(e)}},{key:"pushItem",value:function(e,t){return this.ifPushValid(t)?(e.push(t),t):null}},{key:"entryForEach",value:function(){}},{key:"entryFileHandler",value:function(e,t,r){var n=this,i=t.resolve,a=t.reject,o=[];e.file(function(e){e=r(e);if("function"==typeof n.validFuc&&!n.validFuc(e))return a(new Error(errEnum.stop));n.pushItem(o,e),i(o)})}},{key:"getFileSystemEntryTree",value:function(r){var a=this,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";return new Promise(function(e,t){if(r){var n,i;if(!r.isFile)return r.isDirectory?(i={fullPath:o+(n=r).name,name:n.name,totalSize:0,type:"text/directory",file:new File([],o+n.name,{type:"text/directory"}),child:[]},a.ifPushValid(i)?void dirReadEntry(n,{endFuc:function(){return i.totalSize=i.child.reduce(function(e,t){return e+((null==t?void 0:t.size)||(null==t?void 0:t.totalSize))},0),e([i])},excFuc:function(e,t){var r=t.next;a.getFileSystemEntryTree(e,o+n.name+"/").then(function(e){var t;(t=i.child).push.apply(t,_toConsumableArray(e)),r()},function(e){a.errHanlder(e,function(){r()})})}}):t(new Error(errEnum.filter))):void e([]);a.entryFileHandler(r,{resolve:e,reject:t},function(e){return{size:e.size,fullPath:o+e.name,name:e.name,type:e.type,file:e}})}else e([])})}},{key:"getFileSystemEntryArray",value:function(a){var o=this,u=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";return new Promise(function(e,t){if(a)if(a.isFile)o.entryFileHandler(a,{resolve:e,reject:t},function(e){return{size:e.size,fullPath:u+e.name,name:e.name,type:e.type,file:e}});else if(a.isDirectory){var n=a,i=[],r={fullPath:u+n.name,name:n.name,totalSize:0,type:"text/directory",file:new File([],u+n.name,{type:"text/directory"})};if(!o.onlyFile&&!o.pushItem(i,r))return t(new Error(errEnum.filter));dirReadEntry(n,{endFuc:function(){return o.onlyFile||(i[0].totalSize=i.reduce(function(e,t){return e+((null==t?void 0:t.size)||0)},0)),e(i)},excFuc:function(e,t){var r=t.next;o.getFileSystemEntryArray(e,u+n.name+"/").then(function(e){console.log("results===",e),i.push.apply(i,_toConsumableArray(e)),r()},function(e){o.errHanlder(e,function(){r()})})}})}else e([]);else e([])})}}]),t}();exports.ModeType=ModeType,exports.ResHandle=ResHandle,exports.dirReadEntry=dirReadEntry,exports.errEnum=errEnum,exports.filterSize=filterSize,exports.getFileExtension=getFileExtension,exports.getTargetNode=getTargetNode,exports.selectFileChange=selectFileChange,exports.selectFolderChange=selectFolderChange,exports.selectResource=selectResource;
