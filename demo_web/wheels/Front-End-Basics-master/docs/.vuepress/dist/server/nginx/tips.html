<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx 实操-常用配置 | Front-End-Basics</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="陈方旭的个人文档">
    
    <link rel="preload" href="/assets/css/0.styles.495d9abf.css" as="style"><link rel="preload" href="/assets/js/app.26ddf859.js" as="script"><link rel="preload" href="/assets/js/2.0a0a1bce.js" as="script"><link rel="preload" href="/assets/js/195.bd0371b6.js" as="script"><link rel="prefetch" href="/assets/js/10.7fd8ce8b.js"><link rel="prefetch" href="/assets/js/100.e2e655f5.js"><link rel="prefetch" href="/assets/js/101.03d0acad.js"><link rel="prefetch" href="/assets/js/102.2f60b5a6.js"><link rel="prefetch" href="/assets/js/103.c5e7eb0b.js"><link rel="prefetch" href="/assets/js/104.d493f2a3.js"><link rel="prefetch" href="/assets/js/105.c27b5e53.js"><link rel="prefetch" href="/assets/js/106.819ca6ce.js"><link rel="prefetch" href="/assets/js/107.d60fe526.js"><link rel="prefetch" href="/assets/js/108.33cfb7ed.js"><link rel="prefetch" href="/assets/js/109.004e3009.js"><link rel="prefetch" href="/assets/js/11.b58cc63a.js"><link rel="prefetch" href="/assets/js/110.ffa5fbbc.js"><link rel="prefetch" href="/assets/js/111.f3073fff.js"><link rel="prefetch" href="/assets/js/112.3c09cbc0.js"><link rel="prefetch" href="/assets/js/113.b19590e6.js"><link rel="prefetch" href="/assets/js/114.b802a814.js"><link rel="prefetch" href="/assets/js/115.ef4a42a7.js"><link rel="prefetch" href="/assets/js/116.ba312c6c.js"><link rel="prefetch" href="/assets/js/117.3c81d39e.js"><link rel="prefetch" href="/assets/js/118.06a46444.js"><link rel="prefetch" href="/assets/js/119.49125678.js"><link rel="prefetch" href="/assets/js/12.588d1122.js"><link rel="prefetch" href="/assets/js/120.6caa767c.js"><link rel="prefetch" href="/assets/js/121.cad653d5.js"><link rel="prefetch" href="/assets/js/122.b54e599c.js"><link rel="prefetch" href="/assets/js/123.bcf93ede.js"><link rel="prefetch" href="/assets/js/124.f7768fe4.js"><link rel="prefetch" href="/assets/js/125.2dc9e948.js"><link rel="prefetch" href="/assets/js/126.a0a3e110.js"><link rel="prefetch" href="/assets/js/127.32cae0cf.js"><link rel="prefetch" href="/assets/js/128.391dd8b6.js"><link rel="prefetch" href="/assets/js/129.d7ec7c07.js"><link rel="prefetch" href="/assets/js/13.f855b112.js"><link rel="prefetch" href="/assets/js/130.514a6b2e.js"><link rel="prefetch" href="/assets/js/131.af6e4770.js"><link rel="prefetch" href="/assets/js/132.b5eb4428.js"><link rel="prefetch" href="/assets/js/133.278c6032.js"><link rel="prefetch" href="/assets/js/134.8b4fbfea.js"><link rel="prefetch" href="/assets/js/135.af8c3010.js"><link rel="prefetch" href="/assets/js/136.e8d50939.js"><link rel="prefetch" href="/assets/js/137.062c9279.js"><link rel="prefetch" href="/assets/js/138.748f625e.js"><link rel="prefetch" href="/assets/js/139.c8d452ba.js"><link rel="prefetch" href="/assets/js/14.706c60f4.js"><link rel="prefetch" href="/assets/js/140.e3d090bc.js"><link rel="prefetch" href="/assets/js/141.76309f02.js"><link rel="prefetch" href="/assets/js/142.badcfbea.js"><link rel="prefetch" href="/assets/js/143.9444172a.js"><link rel="prefetch" href="/assets/js/144.6811b2cb.js"><link rel="prefetch" href="/assets/js/145.760e53a6.js"><link rel="prefetch" href="/assets/js/146.6a021bf1.js"><link rel="prefetch" href="/assets/js/147.1a09e987.js"><link rel="prefetch" href="/assets/js/148.4a2102a6.js"><link rel="prefetch" href="/assets/js/149.e4992bc8.js"><link rel="prefetch" href="/assets/js/15.dddbfaa5.js"><link rel="prefetch" href="/assets/js/150.bf99144d.js"><link rel="prefetch" href="/assets/js/151.6cae69ac.js"><link rel="prefetch" href="/assets/js/152.e5a32ff0.js"><link rel="prefetch" href="/assets/js/153.5ec16bda.js"><link rel="prefetch" href="/assets/js/154.b99016d2.js"><link rel="prefetch" href="/assets/js/155.330ba388.js"><link rel="prefetch" href="/assets/js/156.272c4fdd.js"><link rel="prefetch" href="/assets/js/157.37f7adc8.js"><link rel="prefetch" href="/assets/js/158.dd412e9f.js"><link rel="prefetch" href="/assets/js/159.92108a41.js"><link rel="prefetch" href="/assets/js/16.e52b2f0e.js"><link rel="prefetch" href="/assets/js/160.691be0a2.js"><link rel="prefetch" href="/assets/js/161.25591efd.js"><link rel="prefetch" href="/assets/js/162.d383ff2b.js"><link rel="prefetch" href="/assets/js/163.b086f272.js"><link rel="prefetch" href="/assets/js/164.51ec1769.js"><link rel="prefetch" href="/assets/js/165.5101617a.js"><link rel="prefetch" href="/assets/js/166.4adb994b.js"><link rel="prefetch" href="/assets/js/167.d0ab2ea3.js"><link rel="prefetch" href="/assets/js/168.57a9a221.js"><link rel="prefetch" href="/assets/js/169.d6830258.js"><link rel="prefetch" href="/assets/js/17.0668268a.js"><link rel="prefetch" href="/assets/js/170.a1c94b18.js"><link rel="prefetch" href="/assets/js/171.758c4100.js"><link rel="prefetch" href="/assets/js/172.a390e082.js"><link rel="prefetch" href="/assets/js/173.6a612dab.js"><link rel="prefetch" href="/assets/js/174.323cd630.js"><link rel="prefetch" href="/assets/js/175.d2d192f7.js"><link rel="prefetch" href="/assets/js/176.83699347.js"><link rel="prefetch" href="/assets/js/177.58e2a96f.js"><link rel="prefetch" href="/assets/js/178.f20d6711.js"><link rel="prefetch" href="/assets/js/179.246c5b5d.js"><link rel="prefetch" href="/assets/js/18.1ec934a2.js"><link rel="prefetch" href="/assets/js/180.99a7cd1a.js"><link rel="prefetch" href="/assets/js/181.8b2ed6c7.js"><link rel="prefetch" href="/assets/js/182.465f06b6.js"><link rel="prefetch" href="/assets/js/183.d5e9d2a9.js"><link rel="prefetch" href="/assets/js/184.34cddded.js"><link rel="prefetch" href="/assets/js/185.c7a7ab75.js"><link rel="prefetch" href="/assets/js/186.dd1d0e7d.js"><link rel="prefetch" href="/assets/js/187.9655d4c4.js"><link rel="prefetch" href="/assets/js/188.e51e42cf.js"><link rel="prefetch" href="/assets/js/189.7107e215.js"><link rel="prefetch" href="/assets/js/19.b3a69aa1.js"><link rel="prefetch" href="/assets/js/190.aea451e0.js"><link rel="prefetch" href="/assets/js/191.4aa4329e.js"><link rel="prefetch" href="/assets/js/192.d1eb7eb6.js"><link rel="prefetch" href="/assets/js/193.84be6ed1.js"><link rel="prefetch" href="/assets/js/194.d27bdfcd.js"><link rel="prefetch" href="/assets/js/20.4833415c.js"><link rel="prefetch" href="/assets/js/21.623aae45.js"><link rel="prefetch" href="/assets/js/22.0f922dba.js"><link rel="prefetch" href="/assets/js/23.c71d9286.js"><link rel="prefetch" href="/assets/js/24.6331e619.js"><link rel="prefetch" href="/assets/js/25.aebbd191.js"><link rel="prefetch" href="/assets/js/26.4a350a9e.js"><link rel="prefetch" href="/assets/js/27.f0593bbf.js"><link rel="prefetch" href="/assets/js/28.3a3be2a5.js"><link rel="prefetch" href="/assets/js/29.600006cd.js"><link rel="prefetch" href="/assets/js/3.de0ded1b.js"><link rel="prefetch" href="/assets/js/30.fd1bf4df.js"><link rel="prefetch" href="/assets/js/31.c17eec63.js"><link rel="prefetch" href="/assets/js/32.0beb9489.js"><link rel="prefetch" href="/assets/js/33.4b356132.js"><link rel="prefetch" href="/assets/js/34.426a3957.js"><link rel="prefetch" href="/assets/js/35.9e58f8ae.js"><link rel="prefetch" href="/assets/js/36.b304f65d.js"><link rel="prefetch" href="/assets/js/37.102918ae.js"><link rel="prefetch" href="/assets/js/38.b306427b.js"><link rel="prefetch" href="/assets/js/39.8a7ddc82.js"><link rel="prefetch" href="/assets/js/4.6aeff477.js"><link rel="prefetch" href="/assets/js/40.15b85e4a.js"><link rel="prefetch" href="/assets/js/41.7194c6a5.js"><link rel="prefetch" href="/assets/js/42.40d604fe.js"><link rel="prefetch" href="/assets/js/43.1308a197.js"><link rel="prefetch" href="/assets/js/44.a600e34c.js"><link rel="prefetch" href="/assets/js/45.07f1aea4.js"><link rel="prefetch" href="/assets/js/46.ef1cd999.js"><link rel="prefetch" href="/assets/js/47.31ae8f23.js"><link rel="prefetch" href="/assets/js/48.546ddc2b.js"><link rel="prefetch" href="/assets/js/49.6256155f.js"><link rel="prefetch" href="/assets/js/5.3017579e.js"><link rel="prefetch" href="/assets/js/50.9023bd20.js"><link rel="prefetch" href="/assets/js/51.9c0ab442.js"><link rel="prefetch" href="/assets/js/52.e2cc1558.js"><link rel="prefetch" href="/assets/js/53.2a34ee52.js"><link rel="prefetch" href="/assets/js/54.94919a07.js"><link rel="prefetch" href="/assets/js/55.cdcde14b.js"><link rel="prefetch" href="/assets/js/56.402b91d1.js"><link rel="prefetch" href="/assets/js/57.1c816075.js"><link rel="prefetch" href="/assets/js/58.7bc6c53a.js"><link rel="prefetch" href="/assets/js/59.98cd16d3.js"><link rel="prefetch" href="/assets/js/6.c66a9c0d.js"><link rel="prefetch" href="/assets/js/60.c6b1fedf.js"><link rel="prefetch" href="/assets/js/61.77a37644.js"><link rel="prefetch" href="/assets/js/62.33adbccc.js"><link rel="prefetch" href="/assets/js/63.46e827aa.js"><link rel="prefetch" href="/assets/js/64.fccc6652.js"><link rel="prefetch" href="/assets/js/65.784409bc.js"><link rel="prefetch" href="/assets/js/66.0ff33975.js"><link rel="prefetch" href="/assets/js/67.71025c8a.js"><link rel="prefetch" href="/assets/js/68.bc956963.js"><link rel="prefetch" href="/assets/js/69.0835dc3a.js"><link rel="prefetch" href="/assets/js/7.abbb8cf3.js"><link rel="prefetch" href="/assets/js/70.b4997331.js"><link rel="prefetch" href="/assets/js/71.c555d255.js"><link rel="prefetch" href="/assets/js/72.410045e4.js"><link rel="prefetch" href="/assets/js/73.f11bc054.js"><link rel="prefetch" href="/assets/js/74.b0b7f602.js"><link rel="prefetch" href="/assets/js/75.564b469f.js"><link rel="prefetch" href="/assets/js/76.dc701916.js"><link rel="prefetch" href="/assets/js/77.2f2e86ba.js"><link rel="prefetch" href="/assets/js/78.293c88ac.js"><link rel="prefetch" href="/assets/js/79.188e3f3f.js"><link rel="prefetch" href="/assets/js/8.5ca23337.js"><link rel="prefetch" href="/assets/js/80.12817fd5.js"><link rel="prefetch" href="/assets/js/81.20822295.js"><link rel="prefetch" href="/assets/js/82.827507e9.js"><link rel="prefetch" href="/assets/js/83.2669bc92.js"><link rel="prefetch" href="/assets/js/84.587c39a1.js"><link rel="prefetch" href="/assets/js/85.acc07148.js"><link rel="prefetch" href="/assets/js/86.b0c041c1.js"><link rel="prefetch" href="/assets/js/87.d437a0f0.js"><link rel="prefetch" href="/assets/js/88.6e542ac8.js"><link rel="prefetch" href="/assets/js/89.dc44df50.js"><link rel="prefetch" href="/assets/js/9.8b8ba95c.js"><link rel="prefetch" href="/assets/js/90.61a1b726.js"><link rel="prefetch" href="/assets/js/91.3f4b2a8a.js"><link rel="prefetch" href="/assets/js/92.cd3aa7ff.js"><link rel="prefetch" href="/assets/js/93.ce269678.js"><link rel="prefetch" href="/assets/js/94.b5bf35e9.js"><link rel="prefetch" href="/assets/js/95.412f527b.js"><link rel="prefetch" href="/assets/js/96.9af6b5f0.js"><link rel="prefetch" href="/assets/js/97.ffe88ff0.js"><link rel="prefetch" href="/assets/js/98.9c55d95f.js"><link rel="prefetch" href="/assets/js/99.b9b8c7f7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.495d9abf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Front-End-Basics" class="logo"> <span class="site-name can-hide">Front-End-Basics</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/article/" class="nav-link">
  捡贝壳
</a></div> <a href="https://github.com/qiqihaobenben/Front-End-Basics" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/article/" class="nav-link">
  捡贝壳
</a></div> <a href="https://github.com/qiqihaobenben/Front-End-Basics" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/server/linux/computer.html" class="sidebar-link">计算机基础和 Linux 基础</a></li><li><a href="/server/linux/basics.html" class="sidebar-link">Linux 版本详述</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Shell</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/server/shell/basics.html" class="sidebar-link">Shell 概览</a></li><li><a href="/server/shell/script.html" class="sidebar-link">Shell 脚本编程详解</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Nginx</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/server/nginx/introduction.html" class="sidebar-link">Nginx 介绍</a></li><li><a href="/server/nginx/install.html" class="sidebar-link">Nginx 安装</a></li><li><a href="/server/nginx/command.html" class="sidebar-link">Nginx 操作命令</a></li><li><a href="/server/nginx/config.html" class="sidebar-link">Nginx 基础配置和语法</a></li><li><a href="/server/nginx/static.html" class="sidebar-link">Nginx 实操-静态资源服务器</a></li><li><a href="/server/nginx/proxy.html" class="sidebar-link">Nginx 实操-代理相关</a></li><li><a href="/server/nginx/tips.html" aria-current="page" class="active sidebar-link">Nginx 实操-常用配置</a></li><li><a href="/server/nginx/advance.html" class="sidebar-link">Nginx 进阶</a></li><li><a href="/server/nginx/process.html" class="sidebar-link">Nginx 执行流程</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx-实操-常用配置"><a href="#nginx-实操-常用配置" class="header-anchor">#</a> Nginx 实操-常用配置</h1> <h2 id="适配-pc-与-移动环境"><a href="#适配-pc-与-移动环境" class="header-anchor">#</a> 适配 PC 与 移动环境</h2> <p>现在很多网站都同时存在 PC 站和 H5 站，因此根据用户的浏览环境自动切换站点是很常见的需求。Nginx 可以通过内置变量 <code>$http_user_agent</code>，获取到请求客户端的 userAgent，从而知道用户处于移动端还是 PC 端，进而控制重定向到 PC 站 还是 H5 站，例如 PC 端站点为 <code>example.com</code>，H5 端站点为 <code>h5.example.com</code>，就可以在 PC 端配置 Nginx ：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span> example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">root</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>app<span class="token operator">/</span>pc<span class="token punctuation">;</span> <span class="token comment">#pc 的 html 路径</span>
    <span class="token comment">#获取 userAgent</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token string">'(Android|webOS|iPhone|iPad|BlackBerry)'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">+</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>h5<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="图片处理"><a href="#图片处理" class="header-anchor">#</a> 图片处理</h2> <p>在前端开发中，经常需要不同尺寸的图片。现在的云存储基本对图片都提供有处理服务（一般是通过在图片链接上加参数）。用 Nginx 可以通过几十行配置，搭建出一个属于自己的本地图片处理服务，完全能够满足日常对图片的裁剪、缩放、旋转、图片品质等处理需求。需要用到 <a href="http://nginx.org/en/docs/http/ngx_http_image_filter_module.html" target="_blank" rel="noopener noreferrer"><code>ngx_http_image_filter_module</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 模块，这个模块是非基本模块，需要安装。此外还可以通过 proxy_cache 配置 Nginx 缓存，避免每次请求都重新处理图片，减少 Nginx 服务器处理压力，还可以通过和 <a href="http://www.nginxguts.com/nginx-upload-module/" target="_blank" rel="noopener noreferrer"><code>nginx-upload-module</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 一起使用加入图片上传的功能。</p> <p>图片缩放功能示例：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># example.com/img/ 路径会进行图片处理</span>
<span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">/</span>image<span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
  <span class="token keyword">alias</span> <span class="token operator">/</span>home<span class="token operator">/</span>www<span class="token operator">/</span>static<span class="token operator">/</span>image<span class="token operator">/</span>$<span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment"># 图片服务端存储地址</span>
  <span class="token keyword">set</span> <span class="token variable">$width</span> <span class="token operator">-</span><span class="token punctuation">;</span> <span class="token comment"># 图片宽度默认值</span>
  <span class="token keyword">set</span> <span class="token variable">$height</span> <span class="token operator">-</span><span class="token punctuation">;</span> <span class="token comment"># 图片高度默认值</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$arg_width</span> <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">set</span> <span class="token variable">$width</span> <span class="token variable">$arg_width</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$arg_height</span> <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">set</span> <span class="token variable">$height</span> <span class="token variable">$arg_height</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">image_filter</span> resize <span class="token variable">$width</span> <span class="token variable">$height</span><span class="token punctuation">;</span> <span class="token comment"># 设置图片宽高</span>
  <span class="token keyword">image_filter_buffer</span> <span class="token number">10</span>M<span class="token punctuation">;</span> <span class="token comment"># 设置 Nginx 读取图片的最大 buffer</span>
  image_filter_interlace on<span class="token punctuation">;</span> <span class="token comment"># 是否开启图片图像隔行扫描</span>
  <span class="token keyword">error_page</span> <span class="token number">500</span> <span class="token operator">=</span> <span class="token number">500.</span>png<span class="token punctuation">;</span> <span class="token comment"># 图片处理错误提示图，例如缩放参数不是数字</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="页面内容修改"><a href="#页面内容修改" class="header-anchor">#</a> 页面内容修改</h2> <p>Nginx 可以通过向页面底部或者顶部插入额外的 css 和 js 文件，从而实现修改页面内容。这个功能需要额外模块支持，例如 <a href="https://github.com/alibaba/nginx-http-footer-filter" target="_blank" rel="noopener noreferrer"><code>nginx-http-footer-filter</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或者 <a href="http://nginx.org/en/docs/http/ngx_http_addition_module.html" target="_blank" rel="noopener noreferrer"><code>ngx_http_addition_module</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。工作中，经常需要切换各种测试环境，而通过 switchhosts 等工具切换后，有时还需要清理浏览器 dns 缓存。可以通过页面内容修改 + Nginx 反向代理来实现轻松快捷的环境切换。这里首先在本地编写一段 js 代码（switchhost.js）里面的逻辑是：在页面插入 hosts 切换菜单以及点击具体某个环境时，将该 host 的 ip 和 hostname 存储在 cookie 中，最后刷新页面；接着编写一段 css 代码（switchhost.css）用来设置该 hosts 切换菜单的样式。最后 Nginx 脚本配置：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span> example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
  <span class="token keyword">set</span> <span class="token variable">$root</span> <span class="token operator">/</span>home<span class="token operator">/</span>www<span class="token operator">/</span>example<span class="token punctuation">;</span>
  <span class="token keyword">charset</span> utf<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">;</span>
  <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>
  <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>exmaple<span class="token punctuation">.</span>com<span class="token punctuation">.</span>key<span class="token punctuation">;</span>

  <span class="token comment"># 设置默认 host，一般默认为线上 host，这里是随便写的</span>
  <span class="token keyword">set</span> <span class="token variable">$switch_host</span> <span class="token string">'8,8,8,8'</span><span class="token punctuation">;</span>
  <span class="token comment"># 设置默认 hostname，一般默认为线上 'online'</span>
  <span class="token keyword">set</span> <span class="token variable">$switch_hostname</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token comment"># 从 cookie 中获取环境 ip</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_cookie</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token string">&quot;switch_host=(.+?)(?=;|$)&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">set</span> <span class="token variable">$switch_host</span> $<span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># 从 cookie 中获取环境名称</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_cookie</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token string">&quot;switch_hostname=(.+?)(?=;|$)&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">set</span> <span class="token variable">$switch_hostname</span> $<span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span><span class="token punctuation">;</span>
    <span class="token comment"># 把 html 页面的 gzip 压缩去掉，不然 sub_filter 无法替换内容</span>
    <span class="token keyword">proxy_set_header</span> Accept<span class="token operator">-</span>Encoding<span class="token punctuation">;</span>
    <span class="token comment"># 反向代理到实际服务器 ip</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$switch_host</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token comment"># 全部替换</span>
    <span class="token keyword">sub_filter_once</span> off<span class="token punctuation">;</span>
    <span class="token comment"># ngx_http_addition_module 模块替换内容</span>
    <span class="token comment"># 这里在头部插入一段 css，内容是 hosts 切换菜单的 css 样式</span>
    <span class="token keyword">sub_filter</span> <span class="token string">'&lt;/head&gt;'</span> <span class="token string">'&lt;/head&gt;&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; media=&quot;screen&quot; href=&quot;/local/switchhost.css&quot; /&gt;'</span><span class="token punctuation">;</span>

    <span class="token comment"># 这里使用另一个模块 nginx-http-footer-filter，其实上面的模块就行，只是为了展示用法</span>
    <span class="token comment"># 最后插入一段 js，内容是 hosts 切换菜单的 js 逻辑</span>
    <span class="token keyword">set</span> <span class="token variable">$injected</span> <span class="token string">'&lt;script src=&quot;/local/switchhost.js&quot;&gt;&lt;/script&gt;'</span><span class="token punctuation">;</span>
    footer <span class="token string">'$injected'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># 对于 /local/ 请求，优先匹配本地文件</span>
  <span class="token comment"># 所以上面的 /local/switchhost.css，/local/switchhost.js 会从本地获取</span>
  <span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>local<span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">root</span> <span class="token variable">$root</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个功能其实为 Nginx 在前端开发中的应用提供了无限可能。例如，可以通过区分本地、测试和线上环境，为本地、测试环境页面增加很多开发辅助功能：给本地页面增加一个常驻二维码便于手机端扫码调试；本地调试线上页面时，在 js 文件底部加入 sourceMappingURL，便于本地 debug 等等。</p> <h2 id="请求限制"><a href="#请求限制" class="header-anchor">#</a> 请求限制</h2> <p>对于大流量恶意的访问，会造成带宽的浪费，给服务器增加压力。可以通过 Nginx 对于同一 IP 的连接数以及并发数进行限制。合理的控制还可以用来防止 DDos 和 CC 攻击。</p> <p>关于请求限制主要使用 Nginx 默认集成的 2 个模块：</p> <ul><li>ngx_http_limit_conn_module 连接频率限制模块</li> <li>ngx_http_limit_req_module 请求频率限制模块</li></ul> <p>涉及到的配置主要是:</p> <ul><li>limit_req_zone 限制请求数</li> <li>limit_conn_zone 限制并发连接数</li></ul> <h2 id="图片防盗链"><a href="#图片防盗链" class="header-anchor">#</a> 图片防盗链</h2> <h3 id="简单有效的防盗链手段-referer-模块"><a href="#简单有效的防盗链手段-referer-模块" class="header-anchor">#</a> 简单有效的防盗链手段：referer 模块</h3> <p>使用场景例如某网站通过 url 引用了你的页面，当用户在浏览器上点击 url 时，http 请求的头部中会通过 referer 头部将该网站当前页面的 url 带上，告诉服务器本次请求是由这个页面发起的。通过 referer 模块，用 invalid_referer 变量根据配置判断 referer 头部是否合法。从而拒绝第三方网站访问我们站点的资源。referer 模块默认编译进 Nginx。</p> <h4 id="valid-referers-指令"><a href="#valid-referers-指令" class="header-anchor">#</a> valid_referers 指令</h4> <p>语法 <code>valid_referers none | blocked | server_names | string...</code></p> <ul><li>none 允许缺失 referer 头部的请求访问</li> <li>block 允许 referer 头部没有对应的值的请求访问</li> <li>server_names 若 referer 中站点域名与 server_name 中本机域名某个匹配，则允许该请求访问。</li> <li>string 域名及 URL 如果是字符串，域名可在前缀或者后缀中含有 <code>*</code> 通配符，若 referer 头部的值匹配字符串后，则允许请求访问；域名如果是正则表达式，若 referer 头部的值匹配正则表达式后，则允许请求访问</li></ul> <p><strong>valid_referers 指令后面可以同时携带多个参数，表示多个 referer 头部都生效。模块还会提供出一个 <code>$invalid_referer</code> 变量，允许访问时变量值为空，不允许访问时变量值为 1。</strong></p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span> <span class="token operator">*</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

  <span class="token comment"># 图片防盗链</span>
  <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token operator">|</span>swf<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
    <span class="token keyword">valid_referers</span> none blocked server_names <span class="token operator">~</span>\<span class="token punctuation">.</span>google\<span class="token punctuation">.</span> <span class="token operator">~</span>\<span class="token punctuation">.</span>baidu\<span class="token punctuation">.</span> <span class="token operator">*</span><span class="token punctuation">.</span>qq<span class="token punctuation">.</span>com<span class="token punctuation">;</span> <span class="token comment"># 允许没有 referer 头或者值为空，或者google、baidu、qq.com。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$invalid_referer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="secure-link-模块防盗链"><a href="#secure-link-模块防盗链" class="header-anchor">#</a> secure_link 模块防盗链</h3> <p>通过验证 URL 中哈希值的方式防盗链，该模块默认未编译进 Nginx。</p> <p>实现的功能过程是由某服务器（也可以是 Nginx）生成加密后的安全链接 url，返回给客户端。客户端使用安全 url 访问 Nginx，由 Nginx 的 <code>$secure_link</code> 变量判断判断是否验证通过。</p> <p>实现的原理是：</p> <ul><li>哈希算法是不可逆的</li> <li>客户端只能拿到执行过哈希算法的 URL</li> <li>仅生成 URL 的服务器、验证 URL 是否安全的 Nginx 这二者，才保存执行哈希算法前的原始字符串</li> <li>原始字符串通常由以下部分有序组成：
<ul><li>资源位置，例如 HTTP 中指定资源的 URI，防止攻击者拿到一个安全 URI 后可以访问任意资源</li> <li>用户信息，例如用户 IP 地址，限制其他用户盗用安全 URI</li> <li>时间戳，使安全 URI 及时过期</li> <li>密钥，仅服务器端拥有，增加攻击者猜测出原始字符串的难度</li></ul></li></ul> <p>模块提供了两个变量：</p> <ul><li><code>$secure_link</code> 值为空字符串，表示验证不通过，值为 0，表示 URL 过期，值为 1，表示验证通过</li> <li><code>$secure_link_expires</code> 时间戳的值</li></ul> <h4 id="secure-link-指令"><a href="#secure-link-指令" class="header-anchor">#</a> secure_link 指令</h4> <p>有两个参数，第一个参数是哈希值，第二个参数是时间戳</p> <ul><li>首先使用命令行生成安全链接
<ul><li>生成 MD5 <code>echo -n '时间戳URL客户端IP密钥' | openssl md5 -binary | openssl base64 | tr +/ -_ | tr -d =</code> 例如 <code>echo -n '2147483647/test1.txt116.62.160.193 secret' | openssl md5 -binary | openssl base64 | tr +/ -_ | tr -d =</code></li> <li>原请求 <code>/test1.txt?md5=md5生成值&amp;expires=时间戳（如 2147483647）</code></li></ul></li> <li>Nginx 配置
<ul><li><code>secure_link $arg_md5,$arg_expires;</code></li> <li><code>secure_link_md5 &quot;$secure_link_expires$uri$remote_addr secret&quot;;</code></li></ul></li></ul> <h4 id="secure-link-secret-指令"><a href="#secure-link-secret-指令" class="header-anchor">#</a> secure_link_secret 指令</h4> <p>采用仅对 URI 进行哈希的简单办法。就是将请求 URL 分为三个部分：/prefix/hash/link，Hash 生成方式是对 &quot;link 密钥&quot; 做 md5 哈希求值，在 Nginx 中使用 secure_link_secret secret; 配置密钥。</p> <ul><li>命令行生成安全连接
<ul><li>原请求 <code>link</code></li> <li>生成的安全请求 <code>/prefix/md5/link</code></li> <li>生成 md5 <code>echo -n 'linksecret' | openssl -md5 -hex</code> 例如 <code>echo -n 'test1.txtsecret2' | openssl md5 -hex</code></li></ul></li> <li>Nginx 配置
<ul><li><code>secure_link_secret secret2</code>;</li></ul></li></ul> <h2 id="单页面项目-history-路由配置"><a href="#单页面项目-history-路由配置" class="header-anchor">#</a> 单页面项目 history 路由配置</h2> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span> test<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">root</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>app<span class="token operator">/</span>dist<span class="token punctuation">;</span> <span class="token comment"># 前端打包后的文件夹</span>
    <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
    <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span><span class="token operator">/</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html @rewrites<span class="token punctuation">;</span> <span class="token comment"># 默认目录下的 index.html，如果都不存在则重定向</span>

    <span class="token keyword">expires</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment"># 首页一般没有强制缓存</span>
    <span class="token keyword">add_header</span> Cache<span class="token operator">-</span>Control no<span class="token operator">-</span>cache<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">location</span> @rewrites <span class="token punctuation">{</span> <span class="token operator">/</span><span class="token operator">/</span> 重定向设置
    <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span>$ <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="请求过滤"><a href="#请求过滤" class="header-anchor">#</a> 请求过滤</h2> <h3 id="过滤指定-user-agent"><a href="#过滤指定-user-agent" class="header-anchor">#</a> 过滤指定 user_agent</h3> <p>Nginx 可以禁止指定的浏览器和爬虫框架访问：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 禁止 user_agent 为 baidu、360和sohu，~* 表示不区分大小写匹配</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token string">'baidu|360|sohu'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">404</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment"># 禁止 Scrapy 等工具的抓取</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token punctuation">(</span>Scrapy<span class="token operator">|</span>Curl<span class="token operator">|</span>HttpClient<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="根据请求类型过滤"><a href="#根据请求类型过滤" class="header-anchor">#</a> 根据请求类型过滤</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 非指定请求就返回 403</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">!</span><span class="token operator">~</span> <span class="token operator">^</span><span class="token punctuation">(</span>GET<span class="token operator">|</span>POST<span class="token operator">|</span>HEAD<span class="token punctuation">)</span>$<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="根据状态码过滤"><a href="#根据状态码过滤" class="header-anchor">#</a> 根据状态码过滤</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">error_page</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html；
<span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html <span class="token punctuation">{</span>
  <span class="token keyword">root</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样实际上是一个内部跳转，当访问出现 502、503 的时候就能返回 50x.html 中的内容，这里需要注意是否可以找到 50x.html 页面，所以加了个 location 保证找到自定义的 50x 页面。</p> <h3 id="根据-url-名称过滤"><a href="#根据-url-名称过滤" class="header-anchor">#</a> 根据 URL 名称过滤</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$host</span> <span class="token operator">=</span> <span class="token string">'ab.com'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment"># 其中，$1 是取自 regex 部分 () 里的内容，匹配成功后跳转到的 URL</span>
  <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$ <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>ab<span class="token punctuation">.</span>com<span class="token operator">/</span>$<span class="token number">1</span> permanent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">location</span> <span class="token operator">/</span>test <span class="token punctuation">{</span>
  <span class="token comment"># /test 全部重定向到首页</span>
  <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$ <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html redirect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="泛域名路径分离"><a href="#泛域名路径分离" class="header-anchor">#</a> 泛域名路径分离</h2> <p>这是一个非常实用的技能，我们可能需要配置一些二级或者三级域名，希望通过 Nginx 自动指向对应目录，比如：</p> <ol><li>test1.com 自动指向 /usr/local/html/test1 服务器地址；</li> <li>test2.com 自动指向 /usr/local/html/test2 服务器地址；</li></ol> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  listren <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span> <span class="token operator">~</span><span class="token operator">^</span><span class="token punctuation">(</span>\w<span class="token operator">+</span><span class="token punctuation">)</span>\<span class="token punctuation">.</span>com$<span class="token punctuation">;</span>

  <span class="token keyword">root</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>html<span class="token operator">/</span>$<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/qiqihaobenben/Front-End-Basics/edit/master/docs/server/nginx/tips.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/2/2021, 10:49:54 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/server/nginx/proxy.html" class="prev">
        Nginx 实操-代理相关
      </a></span> <span class="next"><a href="/server/nginx/advance.html">
        Nginx 进阶
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.26ddf859.js" defer></script><script src="/assets/js/2.0a0a1bce.js" defer></script><script src="/assets/js/195.bd0371b6.js" defer></script>
  </body>
</html>
