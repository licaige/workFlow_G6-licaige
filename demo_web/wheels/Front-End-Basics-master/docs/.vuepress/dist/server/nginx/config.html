<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx 基础配置和语法 | Front-End-Basics</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="陈方旭的个人文档">
    
    <link rel="preload" href="/assets/css/0.styles.495d9abf.css" as="style"><link rel="preload" href="/assets/js/app.26ddf859.js" as="script"><link rel="preload" href="/assets/js/2.0a0a1bce.js" as="script"><link rel="preload" href="/assets/js/190.aea451e0.js" as="script"><link rel="prefetch" href="/assets/js/10.7fd8ce8b.js"><link rel="prefetch" href="/assets/js/100.e2e655f5.js"><link rel="prefetch" href="/assets/js/101.03d0acad.js"><link rel="prefetch" href="/assets/js/102.2f60b5a6.js"><link rel="prefetch" href="/assets/js/103.c5e7eb0b.js"><link rel="prefetch" href="/assets/js/104.d493f2a3.js"><link rel="prefetch" href="/assets/js/105.c27b5e53.js"><link rel="prefetch" href="/assets/js/106.819ca6ce.js"><link rel="prefetch" href="/assets/js/107.d60fe526.js"><link rel="prefetch" href="/assets/js/108.33cfb7ed.js"><link rel="prefetch" href="/assets/js/109.004e3009.js"><link rel="prefetch" href="/assets/js/11.b58cc63a.js"><link rel="prefetch" href="/assets/js/110.ffa5fbbc.js"><link rel="prefetch" href="/assets/js/111.f3073fff.js"><link rel="prefetch" href="/assets/js/112.3c09cbc0.js"><link rel="prefetch" href="/assets/js/113.b19590e6.js"><link rel="prefetch" href="/assets/js/114.b802a814.js"><link rel="prefetch" href="/assets/js/115.ef4a42a7.js"><link rel="prefetch" href="/assets/js/116.ba312c6c.js"><link rel="prefetch" href="/assets/js/117.3c81d39e.js"><link rel="prefetch" href="/assets/js/118.06a46444.js"><link rel="prefetch" href="/assets/js/119.49125678.js"><link rel="prefetch" href="/assets/js/12.588d1122.js"><link rel="prefetch" href="/assets/js/120.6caa767c.js"><link rel="prefetch" href="/assets/js/121.cad653d5.js"><link rel="prefetch" href="/assets/js/122.b54e599c.js"><link rel="prefetch" href="/assets/js/123.bcf93ede.js"><link rel="prefetch" href="/assets/js/124.f7768fe4.js"><link rel="prefetch" href="/assets/js/125.2dc9e948.js"><link rel="prefetch" href="/assets/js/126.a0a3e110.js"><link rel="prefetch" href="/assets/js/127.32cae0cf.js"><link rel="prefetch" href="/assets/js/128.391dd8b6.js"><link rel="prefetch" href="/assets/js/129.d7ec7c07.js"><link rel="prefetch" href="/assets/js/13.f855b112.js"><link rel="prefetch" href="/assets/js/130.514a6b2e.js"><link rel="prefetch" href="/assets/js/131.af6e4770.js"><link rel="prefetch" href="/assets/js/132.b5eb4428.js"><link rel="prefetch" href="/assets/js/133.278c6032.js"><link rel="prefetch" href="/assets/js/134.8b4fbfea.js"><link rel="prefetch" href="/assets/js/135.af8c3010.js"><link rel="prefetch" href="/assets/js/136.e8d50939.js"><link rel="prefetch" href="/assets/js/137.062c9279.js"><link rel="prefetch" href="/assets/js/138.748f625e.js"><link rel="prefetch" href="/assets/js/139.c8d452ba.js"><link rel="prefetch" href="/assets/js/14.706c60f4.js"><link rel="prefetch" href="/assets/js/140.e3d090bc.js"><link rel="prefetch" href="/assets/js/141.76309f02.js"><link rel="prefetch" href="/assets/js/142.badcfbea.js"><link rel="prefetch" href="/assets/js/143.9444172a.js"><link rel="prefetch" href="/assets/js/144.6811b2cb.js"><link rel="prefetch" href="/assets/js/145.760e53a6.js"><link rel="prefetch" href="/assets/js/146.6a021bf1.js"><link rel="prefetch" href="/assets/js/147.1a09e987.js"><link rel="prefetch" href="/assets/js/148.4a2102a6.js"><link rel="prefetch" href="/assets/js/149.e4992bc8.js"><link rel="prefetch" href="/assets/js/15.dddbfaa5.js"><link rel="prefetch" href="/assets/js/150.bf99144d.js"><link rel="prefetch" href="/assets/js/151.6cae69ac.js"><link rel="prefetch" href="/assets/js/152.e5a32ff0.js"><link rel="prefetch" href="/assets/js/153.5ec16bda.js"><link rel="prefetch" href="/assets/js/154.b99016d2.js"><link rel="prefetch" href="/assets/js/155.330ba388.js"><link rel="prefetch" href="/assets/js/156.272c4fdd.js"><link rel="prefetch" href="/assets/js/157.37f7adc8.js"><link rel="prefetch" href="/assets/js/158.dd412e9f.js"><link rel="prefetch" href="/assets/js/159.92108a41.js"><link rel="prefetch" href="/assets/js/16.e52b2f0e.js"><link rel="prefetch" href="/assets/js/160.691be0a2.js"><link rel="prefetch" href="/assets/js/161.25591efd.js"><link rel="prefetch" href="/assets/js/162.d383ff2b.js"><link rel="prefetch" href="/assets/js/163.b086f272.js"><link rel="prefetch" href="/assets/js/164.51ec1769.js"><link rel="prefetch" href="/assets/js/165.5101617a.js"><link rel="prefetch" href="/assets/js/166.4adb994b.js"><link rel="prefetch" href="/assets/js/167.d0ab2ea3.js"><link rel="prefetch" href="/assets/js/168.57a9a221.js"><link rel="prefetch" href="/assets/js/169.d6830258.js"><link rel="prefetch" href="/assets/js/17.0668268a.js"><link rel="prefetch" href="/assets/js/170.a1c94b18.js"><link rel="prefetch" href="/assets/js/171.758c4100.js"><link rel="prefetch" href="/assets/js/172.a390e082.js"><link rel="prefetch" href="/assets/js/173.6a612dab.js"><link rel="prefetch" href="/assets/js/174.323cd630.js"><link rel="prefetch" href="/assets/js/175.d2d192f7.js"><link rel="prefetch" href="/assets/js/176.83699347.js"><link rel="prefetch" href="/assets/js/177.58e2a96f.js"><link rel="prefetch" href="/assets/js/178.f20d6711.js"><link rel="prefetch" href="/assets/js/179.246c5b5d.js"><link rel="prefetch" href="/assets/js/18.1ec934a2.js"><link rel="prefetch" href="/assets/js/180.99a7cd1a.js"><link rel="prefetch" href="/assets/js/181.8b2ed6c7.js"><link rel="prefetch" href="/assets/js/182.465f06b6.js"><link rel="prefetch" href="/assets/js/183.d5e9d2a9.js"><link rel="prefetch" href="/assets/js/184.34cddded.js"><link rel="prefetch" href="/assets/js/185.c7a7ab75.js"><link rel="prefetch" href="/assets/js/186.dd1d0e7d.js"><link rel="prefetch" href="/assets/js/187.9655d4c4.js"><link rel="prefetch" href="/assets/js/188.e51e42cf.js"><link rel="prefetch" href="/assets/js/189.7107e215.js"><link rel="prefetch" href="/assets/js/19.b3a69aa1.js"><link rel="prefetch" href="/assets/js/191.4aa4329e.js"><link rel="prefetch" href="/assets/js/192.d1eb7eb6.js"><link rel="prefetch" href="/assets/js/193.84be6ed1.js"><link rel="prefetch" href="/assets/js/194.d27bdfcd.js"><link rel="prefetch" href="/assets/js/195.bd0371b6.js"><link rel="prefetch" href="/assets/js/20.4833415c.js"><link rel="prefetch" href="/assets/js/21.623aae45.js"><link rel="prefetch" href="/assets/js/22.0f922dba.js"><link rel="prefetch" href="/assets/js/23.c71d9286.js"><link rel="prefetch" href="/assets/js/24.6331e619.js"><link rel="prefetch" href="/assets/js/25.aebbd191.js"><link rel="prefetch" href="/assets/js/26.4a350a9e.js"><link rel="prefetch" href="/assets/js/27.f0593bbf.js"><link rel="prefetch" href="/assets/js/28.3a3be2a5.js"><link rel="prefetch" href="/assets/js/29.600006cd.js"><link rel="prefetch" href="/assets/js/3.de0ded1b.js"><link rel="prefetch" href="/assets/js/30.fd1bf4df.js"><link rel="prefetch" href="/assets/js/31.c17eec63.js"><link rel="prefetch" href="/assets/js/32.0beb9489.js"><link rel="prefetch" href="/assets/js/33.4b356132.js"><link rel="prefetch" href="/assets/js/34.426a3957.js"><link rel="prefetch" href="/assets/js/35.9e58f8ae.js"><link rel="prefetch" href="/assets/js/36.b304f65d.js"><link rel="prefetch" href="/assets/js/37.102918ae.js"><link rel="prefetch" href="/assets/js/38.b306427b.js"><link rel="prefetch" href="/assets/js/39.8a7ddc82.js"><link rel="prefetch" href="/assets/js/4.6aeff477.js"><link rel="prefetch" href="/assets/js/40.15b85e4a.js"><link rel="prefetch" href="/assets/js/41.7194c6a5.js"><link rel="prefetch" href="/assets/js/42.40d604fe.js"><link rel="prefetch" href="/assets/js/43.1308a197.js"><link rel="prefetch" href="/assets/js/44.a600e34c.js"><link rel="prefetch" href="/assets/js/45.07f1aea4.js"><link rel="prefetch" href="/assets/js/46.ef1cd999.js"><link rel="prefetch" href="/assets/js/47.31ae8f23.js"><link rel="prefetch" href="/assets/js/48.546ddc2b.js"><link rel="prefetch" href="/assets/js/49.6256155f.js"><link rel="prefetch" href="/assets/js/5.3017579e.js"><link rel="prefetch" href="/assets/js/50.9023bd20.js"><link rel="prefetch" href="/assets/js/51.9c0ab442.js"><link rel="prefetch" href="/assets/js/52.e2cc1558.js"><link rel="prefetch" href="/assets/js/53.2a34ee52.js"><link rel="prefetch" href="/assets/js/54.94919a07.js"><link rel="prefetch" href="/assets/js/55.cdcde14b.js"><link rel="prefetch" href="/assets/js/56.402b91d1.js"><link rel="prefetch" href="/assets/js/57.1c816075.js"><link rel="prefetch" href="/assets/js/58.7bc6c53a.js"><link rel="prefetch" href="/assets/js/59.98cd16d3.js"><link rel="prefetch" href="/assets/js/6.c66a9c0d.js"><link rel="prefetch" href="/assets/js/60.c6b1fedf.js"><link rel="prefetch" href="/assets/js/61.77a37644.js"><link rel="prefetch" href="/assets/js/62.33adbccc.js"><link rel="prefetch" href="/assets/js/63.46e827aa.js"><link rel="prefetch" href="/assets/js/64.fccc6652.js"><link rel="prefetch" href="/assets/js/65.784409bc.js"><link rel="prefetch" href="/assets/js/66.0ff33975.js"><link rel="prefetch" href="/assets/js/67.71025c8a.js"><link rel="prefetch" href="/assets/js/68.bc956963.js"><link rel="prefetch" href="/assets/js/69.0835dc3a.js"><link rel="prefetch" href="/assets/js/7.abbb8cf3.js"><link rel="prefetch" href="/assets/js/70.b4997331.js"><link rel="prefetch" href="/assets/js/71.c555d255.js"><link rel="prefetch" href="/assets/js/72.410045e4.js"><link rel="prefetch" href="/assets/js/73.f11bc054.js"><link rel="prefetch" href="/assets/js/74.b0b7f602.js"><link rel="prefetch" href="/assets/js/75.564b469f.js"><link rel="prefetch" href="/assets/js/76.dc701916.js"><link rel="prefetch" href="/assets/js/77.2f2e86ba.js"><link rel="prefetch" href="/assets/js/78.293c88ac.js"><link rel="prefetch" href="/assets/js/79.188e3f3f.js"><link rel="prefetch" href="/assets/js/8.5ca23337.js"><link rel="prefetch" href="/assets/js/80.12817fd5.js"><link rel="prefetch" href="/assets/js/81.20822295.js"><link rel="prefetch" href="/assets/js/82.827507e9.js"><link rel="prefetch" href="/assets/js/83.2669bc92.js"><link rel="prefetch" href="/assets/js/84.587c39a1.js"><link rel="prefetch" href="/assets/js/85.acc07148.js"><link rel="prefetch" href="/assets/js/86.b0c041c1.js"><link rel="prefetch" href="/assets/js/87.d437a0f0.js"><link rel="prefetch" href="/assets/js/88.6e542ac8.js"><link rel="prefetch" href="/assets/js/89.dc44df50.js"><link rel="prefetch" href="/assets/js/9.8b8ba95c.js"><link rel="prefetch" href="/assets/js/90.61a1b726.js"><link rel="prefetch" href="/assets/js/91.3f4b2a8a.js"><link rel="prefetch" href="/assets/js/92.cd3aa7ff.js"><link rel="prefetch" href="/assets/js/93.ce269678.js"><link rel="prefetch" href="/assets/js/94.b5bf35e9.js"><link rel="prefetch" href="/assets/js/95.412f527b.js"><link rel="prefetch" href="/assets/js/96.9af6b5f0.js"><link rel="prefetch" href="/assets/js/97.ffe88ff0.js"><link rel="prefetch" href="/assets/js/98.9c55d95f.js"><link rel="prefetch" href="/assets/js/99.b9b8c7f7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.495d9abf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Front-End-Basics" class="logo"> <span class="site-name can-hide">Front-End-Basics</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/article/" class="nav-link">
  捡贝壳
</a></div> <a href="https://github.com/qiqihaobenben/Front-End-Basics" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/article/" class="nav-link">
  捡贝壳
</a></div> <a href="https://github.com/qiqihaobenben/Front-End-Basics" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/server/linux/computer.html" class="sidebar-link">计算机基础和 Linux 基础</a></li><li><a href="/server/linux/basics.html" class="sidebar-link">Linux 版本详述</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Shell</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/server/shell/basics.html" class="sidebar-link">Shell 概览</a></li><li><a href="/server/shell/script.html" class="sidebar-link">Shell 脚本编程详解</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Nginx</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/server/nginx/introduction.html" class="sidebar-link">Nginx 介绍</a></li><li><a href="/server/nginx/install.html" class="sidebar-link">Nginx 安装</a></li><li><a href="/server/nginx/command.html" class="sidebar-link">Nginx 操作命令</a></li><li><a href="/server/nginx/config.html" aria-current="page" class="active sidebar-link">Nginx 基础配置和语法</a></li><li><a href="/server/nginx/static.html" class="sidebar-link">Nginx 实操-静态资源服务器</a></li><li><a href="/server/nginx/proxy.html" class="sidebar-link">Nginx 实操-代理相关</a></li><li><a href="/server/nginx/tips.html" class="sidebar-link">Nginx 实操-常用配置</a></li><li><a href="/server/nginx/advance.html" class="sidebar-link">Nginx 进阶</a></li><li><a href="/server/nginx/process.html" class="sidebar-link">Nginx 执行流程</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx-基础配置和语法"><a href="#nginx-基础配置和语法" class="header-anchor">#</a> Nginx 基础配置和语法</h1> <h2 id="全局变量"><a href="#全局变量" class="header-anchor">#</a> 全局变量</h2> <p>Nginx 有一些常用的全局变量，可以在配置的任何位置使用他们。列举一些比较常见的：</p> <table><thead><tr><th>变量</th> <th>描述</th></tr></thead> <tbody><tr><td><strong>HTTP 相关的变量</strong></td> <td></td></tr> <tr><td><code>$host</code></td> <td>请求行中的 Host，如果有 Host 请求头，则用其值替换掉请求行中的主机名，如果请求中没有 Host 行和 Host 请求头，则等于请求匹配的 server 名称（处理请求 server 的 server_name 指令的值），值为小写，不包含端口</td></tr> <tr><td><code>$uri</code></td> <td>请求中的当前 URI（不同于 URL ，不包括 <code>?</code> 后面的请求参数，参数位于 <code>$args</code>），不同于浏览器传递 <code>$request_uri</code> 的值，它可以通过内部重定向，或者使用 index 指令进行修改，不包括协议和主机名，例如 /abc/ef.html</td></tr> <tr><td><code>$document_uri</code></td> <td>当前请求在 root 指令中指定的值，与 <code>$uri</code> 完全相同，历史问题存在</td></tr> <tr><td><code>$request_uri</code></td> <td>完整的原始请求 URL（包括 URI 和完整的参数），它无法修改，请查看 <code>$uri</code> 更改或重写 URL</td></tr> <tr><td><code>$scheme</code></td> <td>请求模式，http 或 https</td></tr> <tr><td><code>$request</code></td> <td>原始的 url 请求，含有方法与协议版本，例如 GET /?a=1&amp;b=22 HTTP/1.1</td></tr> <tr><td><code>$request_method</code></td> <td>客户端请求类型，如 GET、POST</td></tr> <tr><td><code>$request_length</code></td> <td>所有请求内容的大小，包括请求行、头部、包体等</td></tr> <tr><td><code>$request_body</code></td> <td>请求中的包体，这个变量当且仅当使用反向代理，且设定用内存暂存包体时才有效</td></tr> <tr><td><code>$request_body_file</code></td> <td>临时存放请求包体的文件，如果包体非常小则不会存文件，可以通过 client_body_in_file_only 强制所有包体存入文件，且可决定是否删除</td></tr> <tr><td><code>$remote_user</code></td> <td>由 HTTP Basic Authentication 协议传入的用户名</td></tr> <tr><td><code>$args</code></td> <td>请求中的参数，这个变量可以被修改</td></tr> <tr><td><code>$arg_PARAMETER</code></td> <td>GET 请求中变量名 PARAMETER 参数的值，<code>/test?name=abc</code>，<code>$arg_name</code> 为 abc</td></tr> <tr><td><code>$is_args</code></td> <td>如果请求有参数则为 &quot;?&quot;，否则为空字符串&quot;&quot;</td></tr> <tr><td><code>$query_string</code></td> <td>与 <code>$args</code> 相同</td></tr> <tr><td><code>$content_length</code></td> <td>请求头中标识包体长度的 Content-Length 字段</td></tr> <tr><td><code>$content_type</code></td> <td>请求头中标识包体类型的 Content-Type 字段</td></tr> <tr><td><code>$http_HEADER</code></td> <td>HTTP 请求头中的内容，HEADER 为 HTTP 请求中的内容转为小写，- 改为 _ （破折号变为下划线），例如 <code>$http_user_agent</code></td></tr> <tr><td><code>$http_user_agent</code></td> <td>客户端 agent 信息</td></tr> <tr><td><code>$http_cookie</code></td> <td>客户端 cookie 信息</td></tr> <tr><td><code>$cookie_COOKIE</code></td> <td>跟 <code>$arg_PARAMETER</code> 类似，获取某个 cookie 值</td></tr> <tr><td><strong>TCP 连接相关的变量</strong></td> <td></td></tr> <tr><td><code>$binary_remote_addr</code></td> <td>客户端地址的整型格式，对于 IPv4 是 4 字节，对于 IPv6 是 16 字节</td></tr> <tr><td><code>$remote_addr</code></td> <td>客户端的 IP 地址</td></tr> <tr><td><code>$remote_port</code></td> <td>客户端的端口</td></tr> <tr><td><code>$connection</code></td> <td>递增的连接序号</td></tr> <tr><td><code>$connection_requests</code></td> <td>当前连接上执行过的请求数，对 keepalive 连接有意义</td></tr> <tr><td><code>$proxy_protocol_addr</code></td> <td>若使用了 proxy_protocol 协议则返回协议中的地址（原始用户的地址），否则返回空</td></tr> <tr><td><code>$proxy_protocol_port</code></td> <td>若使用了 proxy_protocol 协议则返回协议中的端口（原始用户的端口），否则返回空</td></tr> <tr><td><code>$server_addr</code></td> <td>服务器端地址</td></tr> <tr><td><code>$server_port</code></td> <td>服务器端端口</td></tr> <tr><td><code>$server_protocol</code></td> <td>服务器端协议，例如 HTTP/1.1</td></tr> <tr><td><code>$TCP_INFO</code></td> <td>tcp 内核层参数，包括 <code>$tcpinfo_rtt</code>、<code>$tcpinfo_rttvar</code>、<code>$tcpinfo_snd_cwnd</code>、<code>$tcpinfo_rcv_space</code></td></tr> <tr><td><strong>Nginx 处理请求过程中产生的变量</strong></td> <td></td></tr> <tr><td><code>$request_time</code></td> <td>请求处理到现在的耗时，单位为秒，精确到毫秒</td></tr> <tr><td><code>$server_name</code></td> <td>匹配上请求的 server_name 值</td></tr> <tr><td><code>$https</code></td> <td>如果开启了 TLS/SSL，则返回 on，否则返回空</td></tr> <tr><td><code>$request_completion</code></td> <td>若请求处理完则返回 OK，否则返回空</td></tr> <tr><td><code>$request_id</code></td> <td>以 16 进制输出的请求标识 id，该 id 共含有 16 个字节，是随机生成的</td></tr> <tr><td><code>$request_filename</code></td> <td>待访问文件的完整路径</td></tr> <tr><td><code>$document_root</code></td> <td>由 URI 和 root/alias 规则生成的文件夹路径</td></tr> <tr><td><code>$realpath_root</code></td> <td>将 document_root 中的软链接等换成真实路径</td></tr> <tr><td><code>$limit_rate</code></td> <td>返回客户端响应时的速度上线，单位为每秒字节数。可以通过 <code>set</code> 指令修改对请求产生效果</td></tr> <tr><td><strong>发送 HTTP 响应时相关的变量</strong></td> <td></td></tr> <tr><td><code>$sent_http_HEADER</code></td> <td>HTTP 响应头中的内容，HEADER 为 HTTP 响应中的内容转为小写，- 改为 _ （破折号变为下划线），例如 <code>$sent_http_cache_control</code> 、 <code>sent_http_content_type</code> 等</td></tr> <tr><td><code>$status</code></td> <td>HTTP 响应状态</td></tr> <tr><td><code>$body_bytes_sent</code></td> <td>传送页面的字节数，即响应中 body 包体的长度</td></tr> <tr><td><code>$bytes_sent</code></td> <td>全部 http 响应的长度</td></tr> <tr><td><code>$sent_trailer_名字</code></td> <td>把响应结尾内容里的值返回</td></tr> <tr><td><strong>Nginx 系统变量</strong></td> <td></td></tr> <tr><td><code>$time_local</code></td> <td>以本地时间标准输出的当前时间</td></tr> <tr><td><code>$time_iso8601</code></td> <td>使用 ISO 8601 标准输出的当前时间</td></tr> <tr><td><code>$nginx_version</code></td> <td>当前运行的 Nginx 版本号</td></tr> <tr><td><code>$pid</code></td> <td>所属 worker 进程的 id</td></tr> <tr><td><code>$pipe</code></td> <td>使用了管道则返回 p，否则返回 <code>.</code></td></tr> <tr><td><code>$hostname</code></td> <td>所在服务器的主机名，与 hostname 命令输出一致</td></tr> <tr><td><code>$msec</code></td> <td>1970 年 1 月 1 日到现在的时间，单位为秒，小数点后精确到毫秒</td></tr></tbody></table> <h3 id="nginx-如何设置变量"><a href="#nginx-如何设置变量" class="header-anchor">#</a> Nginx 如何设置变量</h3> <p>Nginx 的配置文件使用的是一门微型的编程语言。既然是编程语言，一般也就少不了 “变量” 这种东西，但是在 Nginx 配置中，变量只能存放一种类型的值，那就是字符串。</p> <p>可以用 <code>set</code> 配置指令动态指定变量的值，Nginx 变量名前面有一个 <code>$</code> 符号，并且所有的 Nginx 变量在 Nginx 配置文件中引用时都必须带上 <code>$</code> 前缀</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">set</span> <span class="token variable">$limit_rate</span> <span class="token number">1</span>K<span class="token punctuation">;</span> <span class="token comment">#限制对客户端的响应传输速率。</span>
</code></pre></div><p>在引用变量时，需要注意引用的变量名之后紧跟着字符时（比如后跟字母、数以及下划线），就需要使用特别的语法来消除歧义：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span> test<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

  <span class="token keyword">set</span> <span class="token variable">$temp</span> hello<span class="token punctuation">;</span>

  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">default_type</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">&quot;$temp world&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">location</span> <span class="token operator">/</span>close <span class="token punctuation">{</span>
    <span class="token keyword">default_type</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">&quot;${hello}world&quot;</span><span class="token punctuation">;</span> <span class="token comment"># 紧跟字符时的用法</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另外需要注意的是，如果想输出 <code>$</code> 符号本身，可以这样做：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">geo</span> <span class="token variable">$dollar</span> <span class="token punctuation">{</span>
  default <span class="token string">&quot;$&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span> test<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

  <span class="token keyword">location</span> <span class="token punctuation">{</span>
    <span class="token keyword">set</span> <span class="token variable">$temp</span> <span class="token string">&quot;hello &quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">default_type</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">&quot;${temp}world：$dollar&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面用到了标准模块 ngx_geo 提供的配置指令 geo 来为变量 <code>${dollar}</code> 赋予字符串 &quot;$&quot;，这样，这里返回的就是 &quot;hello world：$&quot;</p> <h3 id="nginx-变量的实现原理"><a href="#nginx-变量的实现原理" class="header-anchor">#</a> Nginx 变量的实现原理</h3> <p>Nginx 的变量对应的模块可以分为：变量的提供模块和变量的使用模块</p> <ul><li>Nginx 启动时，提供变量的模块可以在 preconfiguration 中定义新的变量，包括定义好<strong>变量名</strong>和<strong>解析出变量的方法</strong></li> <li>HTTP 头部读取完毕后，使用变量的模块，比如 http 的 access 日志，解析 nginx.conf 时定义变量使用方式，处理请求时，会通过变量名去对应的解析出变量的方法中求得变量值</li></ul> <h3 id="map-模块通过映射新变量提供更多的可能性"><a href="#map-模块通过映射新变量提供更多的可能性" class="header-anchor">#</a> map 模块通过映射新变量提供更多的可能性</h3> <p>map 模块可以基于已有变量，使用类似<code>switch {case: ... default ...}</code> 的语法创建新变量，为其他基于变量值实现功能的模块提供更多的可能性。ngx_http_map_module 是默认编译进项目的。</p> <h4 id="map-指令"><a href="#map-指令" class="header-anchor">#</a> map 指令</h4> <p>语法 <code>map string $variable {...}</code>，只能在 http 上下文中使用。</p> <ul><li><code>string</code> 已有变量，可以是字符串、一个或者多个变量、变量和字符串的组合</li> <li><code>$variable</code> 生成的新的变量</li> <li>case 规则（优先级从高到低）
<ul><li>字符串严格匹配</li> <li>使用 hostnames 指令，可以对域名使用前缀 <code>*</code> 泛域名匹配</li> <li>使用 hostnames 指令，可以对域名使用后缀 <code>*</code> 泛域名匹配</li> <li><code>~</code> 和 <code>~*</code> 正则表达式匹配，后者忽略大小写</li></ul></li> <li>default 规则
<ul><li>没有匹配到任何规则时，使用 default</li> <li>缺失 default 时，返回空字符串给新变量，即新变量为 false</li></ul></li> <li>其他情况
<ul><li>使用 include 语法提升可读性</li> <li>使用 volatile 禁止变量值缓存</li></ul></li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">map</span> <span class="token variable">$http_host</span> <span class="token variable">$name</span> <span class="token punctuation">{</span>
  hostnames<span class="token punctuation">;</span>

  default <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token operator">~</span><span class="token keyword">map</span>\<span class="token punctuation">.</span>x\w<span class="token operator">+</span>\<span class="token punctuation">.</span>org<span class="token punctuation">.</span>cn <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">.</span>xu<span class="token punctuation">.</span>org<span class="token punctuation">.</span>cn <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">map</span><span class="token punctuation">.</span>xu<span class="token punctuation">.</span>tech <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">map</span><span class="token punctuation">.</span>xu<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>例如请求头 <code>Host: map.xu.org.cn</code> 泛域名匹配优先于正则匹配，所以 <code>$name</code> 是 2。</p> <h3 id="split-client-模块对少量用户指定变量-可以实现-ab-测试"><a href="#split-client-模块对少量用户指定变量-可以实现-ab-测试" class="header-anchor">#</a> split_client 模块对少量用户指定变量（可以实现 AB 测试）</h3> <p>模块默认编译进 Nginx，基于已有变量（已有变量，可以是字符串、一个或者多个变量、变量和字符串的组合）创建新变量。</p> <p>过程：</p> <ul><li>对已有变量的值执行 MurmurHash2 算法得到 32 位整型哈希数字，记为 hash</li> <li>32 位无符号整型的最大数字 2^32-1，记为 max</li> <li>hash/max 可以得到百分比 percent</li> <li>配置指令中指示了各个百分比构成的范围，如 0-1%,1%-5%等，及范围对应的值</li> <li>当 percent 落在哪个范围里，新变量的值就对应着其后的参数。</li></ul> <p>case 规则</p> <ul><li>xx.xx% 支持小数点后 2 位，所有项的百分比相加不能超过 100%</li> <li><code>*</code> 由它匹配剩余的百分比（100%减去以上所有项相加的百分比）</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">split_clients</span> <span class="token string">&quot;${http_testcli}&quot;</span> <span class="token variable">$variant</span> <span class="token punctuation">{</span>
  <span class="token number">0.51</span><span class="token operator">%</span> <span class="token punctuation">.</span>one<span class="token punctuation">;</span>
  <span class="token number">20.0</span><span class="token operator">%</span> <span class="token punctuation">.</span>tow<span class="token punctuation">;</span>
  <span class="token operator">*</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="geo-模块根据-ip-地址范围生成新变量"><a href="#geo-模块根据-ip-地址范围生成新变量" class="header-anchor">#</a> geo 模块根据 IP 地址范围生成新变量</h3> <p>语法 <code>geo [$address] $variable {...}</code>，根据 IP 地址创建新变量，默认编译进 Nginx。只能在 HTTP 上下文中使用。</p> <ul><li>如果 geo 指令后不输入 $address，那么默认使用 $remote_addr 变量作为 IP 地址</li> <li>{} 内的指令匹配：优先最长匹配
<ul><li>通过 IP 地址及子网掩码的方式，定义 IP 范围，当 IP 地址在范围内时新变量使用其后的参数值</li> <li>default 指定了当以上范围都未匹配上时，新变量的默认值</li> <li>proxy 指定新地址，此时 remote_addr 的值为 X-Forwarded-For 头部值中最后一个 IP 地址</li> <li>include 优化可读性</li> <li>delete 删除指定网络</li></ul></li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">geo</span> <span class="token variable">$country</span> <span class="token punctuation">{</span>
  default ZZ<span class="token punctuation">;</span>

  <span class="token comment">#include conf/geo.conf;</span>
  <span class="token keyword">proxy</span> <span class="token number">116.62</span><span class="token number">.160</span><span class="token number">.193</span><span class="token punctuation">;</span>

  <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> US<span class="token punctuation">;</span>
  <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">32</span> RU<span class="token punctuation">;</span>
  <span class="token number">10.1</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">16</span> RU<span class="token punctuation">;</span>
  <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span> UK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="nginx-配置文件的基本结构"><a href="#nginx-配置文件的基本结构" class="header-anchor">#</a> Nginx 配置文件的基本结构</h2> <p>拿我们之前编译安装的 Nginx 主配置文件 <code>/usr/local/nginx/conf/nginx.conf</code> 来看，<code>nginx.conf</code>的结构图大体如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>main        <span class="token comment"># Nginx 的全局配置，对全局生效</span>
├── events  <span class="token comment"># 配置影响 nginx 服务器或与用户的网络连接</span>
├── http    <span class="token comment"># 配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置，可以嵌套多个 server</span>
│   ├── upstream <span class="token comment"># 配置后端服务器具体地址，负载均衡配置不可或缺的部分</span>
│   ├── server   <span class="token comment"># 配置虚拟主机的相关参数，如域名、IP、端口等，一个 http 块中可以有多个 server 块</span>
│   ├── server
│   │   ├── location  <span class="token comment"># 配置请求的路由，以及各种页面的处理情况</span>
│   │   ├── location  <span class="token comment"># server 块可以包含多个 location 块，location 指令用于匹配 uri</span>
│   │   └── <span class="token punctuation">..</span>.
│   └── <span class="token punctuation">..</span>.
└── <span class="token punctuation">..</span>.
</code></pre></div><h2 id="nginx-配置文件的语法规则"><a href="#nginx-配置文件的语法规则" class="header-anchor">#</a> Nginx 配置文件的语法规则</h2> <p><strong>Nginx 是由一些模块组成，一般在配置文件中使用一些具体的指令来控制。</strong> 指令被分为简单指令（简称指令）和块级指令（简称指令块）。</p> <h3 id="简单指令"><a href="#简单指令" class="header-anchor">#</a> 简单指令</h3> <p>简单指令是由名字和参数组成，中间用空格分开，并以分号结尾。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment">#简单指令</span>
<span class="token keyword">root</span> <span class="token operator">/</span>data<span class="token operator">/</span>www<span class="token punctuation">;</span>
</code></pre></div><h3 id="块级指令"><a href="#块级指令" class="header-anchor">#</a> 块级指令</h3> <p>块级指令跟简单指令有类似的结构，但是末尾不是分号而是用大括号（ <code>{}</code> ）包裹的额外指令集。如果一个块级指令的大括号中有其他指令，则它被叫做一个上下文（比如: events、http、server 和 location）。</p> <p>在配置文件中，没有放在任何上下文中的指令都处在主上下文中。<code>events</code> 和 <code>http</code> 的指令是放在主上下文中，<code>server</code> 放在 <code>http</code> 中，<code>location</code> 放在 <code>server</code> 中。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment">#块级指令</span>
<span class="token keyword">http</span> <span class="token punctuation">{</span>
  <span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">server_name</span> doc<span class="token punctuation">.</span>chenfangxu<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token keyword">access_log</span> logs<span class="token operator">/</span>doc<span class="token punctuation">.</span>chenfangxu<span class="token punctuation">.</span>access<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
    <span class="token keyword">root</span> html<span class="token punctuation">;</span>

    <span class="token keyword">location</span> <span class="token operator">~</span> \<span class="token punctuation">.</span>php$ <span class="token punctuation">{</span>
      <span class="token keyword">fastcgi_pass</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">1025</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="语法规则"><a href="#语法规则" class="header-anchor">#</a> 语法规则</h3> <ul><li>配置文件由指令与指令块构成</li> <li>每条指令以分号（<code>;</code>）结尾，指令与参数间以空格符号分隔</li> <li>指令块以大括号（<code>{}</code>）将多条指令组织在一起</li> <li><code>include</code> 语句允许组合多个配置文件以提升可维护性</li> <li>通过 <code>#</code> 符号添加注释，提高可维护性</li> <li>通过 <code>$</code> 符号使用变量</li> <li>部分指令的参数支持正则表达式，例如常用的 location 指令</li></ul> <h2 id="location-指令规则"><a href="#location-指令规则" class="header-anchor">#</a> location 指令规则</h2> <p>location 指令用于仅匹配 uri，忽略参数，可以使用合法的字符串或者正则表达式</p> <p>语法：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token punctuation">[</span> <span class="token operator">=</span> <span class="token operator">|</span> <span class="token operator">~</span> <span class="token operator">|</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">|</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">|</span> 空<span class="token punctuation">]</span> uri <span class="token punctuation">{</span>
  ……
<span class="token punctuation">}</span>
</code></pre></div><p>指令后面：</p> <ul><li><code>=</code>：精确匹配，用于不含正则表达式的 uri 前，如果匹配成功，不再进行后续的查找</li> <li><code>^~</code>：前缀匹配，用于不含正则表达式的 uri 前，表示如果该符号后面的字符是最佳匹配。采用该规则，不再进行后续的正则查找。跟 <code>=</code> 的区别是，不需要 uri 一模一样，只需要开头和 uri 匹配即可。</li> <li><code>~</code>：正则匹配，表示用该符号后面的正则 uri 去匹配路径，区分大小写</li> <li><code>~*</code>：正则匹配，表示用该符号后面的正则 uri 去匹配路径，不区分大小写。</li> <li><code>空</code>：普通匹配（最长字符匹配），匹配以 uri 开头的字符串，只能是普通字符串。例如，<code>location /</code> 是通用匹配，任何请求都会匹配到。另外普通匹配与 location 顺序无关，是按照匹配的长短来确定匹配结果。</li></ul> <h3 id="优先级"><a href="#优先级" class="header-anchor">#</a> 优先级</h3> <p><code>location =</code> &gt; <code>location 完整路径</code>（还会去匹配正则） &gt; <code>location ^~ 路径</code> &gt; <code>location ~,~* 正则顺序</code> &gt; <code>location 部分起始路径</code> &gt; <code>location /</code></p> <p>即：精确匹配 &gt; 最长字符串匹配，完全匹配（还会去匹配正则） &gt; 前缀匹配 &gt; 正则匹配 &gt; 普通匹配(最长字符串匹配，部分匹配) &gt; 通用匹配</p> <h4 id="注意"><a href="#注意" class="header-anchor">#</a> 注意：</h4> <ul><li>在所有匹配成功的 uri 中，选取匹配度最长的 uri 字符地址。正则除外，正则匹配是按照先后顺序确定匹配结果</li> <li>正则匹配成功之后停止匹配，普通匹配成功后还会接着匹配正则。举个例子：</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># `location 完整路径` 虽然比 `location ^~ 路径` 优先级高，但还是会去匹配正则</span>
<span class="token comment"># 如果正则匹配成功，采用正则匹配结果。如果没有匹配到 `location 完整路径`，`location ^~ 路径` 就比 `location ~,~* 正则顺序` 优先级高了</span>
<span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">/</span>ab <span class="token punctuation">{</span>
  <span class="token keyword">rewrite</span> <span class="token operator">^</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>s<span class="token operator">?</span>word<span class="token operator">=</span>A<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">location</span> <span class="token operator">/</span>abc <span class="token punctuation">{</span>
  <span class="token keyword">rewrite</span> <span class="token operator">^</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>s<span class="token operator">?</span>word<span class="token operator">=</span>B<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>ab <span class="token punctuation">{</span>
  <span class="token keyword">rewrite</span> <span class="token operator">^</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>s<span class="token operator">?</span>word<span class="token operator">=</span>C<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">#访问 http://docs.chenfangxu.com/ab 会跳到百度搜索关键词 C</span>
<span class="token comment">#访问 http://docs.chenfangxu.com/abc 会跳到百度搜索关键词 A</span>
</code></pre></div><ul><li>如果 uri 包含正则表达式，则必须有 <code>~</code> 或 <code>~*</code> 标志，否则正则代码只能作为普通字符使用，例如 <code>location = /demo$</code> ，其中的 <code>$</code> 并不代表正则模式结束，而是一个实实在在的 <code>$</code> 字符，是 url 的一部分。</li> <li>针对 <code>~</code> 和 <code>~*</code> 匹配标识符，可以在前面加上 <code>!</code> 来取反：<code>!~</code>：表示正则不匹配，区分大小写， <code>!~*</code>：表示正则不匹配，不区分大小写</li></ul> <h3 id="根据优先级来模拟-nginx-location-的匹配过程"><a href="#根据优先级来模拟-nginx-location-的匹配过程" class="header-anchor">#</a> 根据优先级来模拟 Nginx location 的匹配过程</h3> <ol><li>Nginx 首先根据 url 检查最长匹配前缀字符串，即会判断 <code>=</code>、<code>^~</code>、<code>空</code> 修饰符定义的内容</li></ol> <ul><li>如果匹配到最长匹配前缀字符串（即最长的 uri）
<ul><li>如果最长匹配前缀字符串被 <code>=</code> 修饰符匹配，则<strong>立即响应</strong></li> <li>如果没有被 <code>=</code> 修饰符匹配，则执行第 2 步判断。</li></ul></li> <li>如果没有匹配到最长匹配前缀字符串</li></ul> <ol start="2"><li>Nginx 继续检查最长匹配前缀字符串，即判断 <code>^~</code>、<code>空</code> 修饰符定义的内容</li></ol> <ul><li>如果最长匹配前缀字符串被 <code>^~</code> 修饰符匹配，则<strong>立即响应</strong></li> <li>如果被 <code>空</code> 修饰符匹配，则<strong>将改匹配保存起来</strong>（不管是普通匹配的完全匹配还是部分匹配），并执行第 3 步判断。</li></ul> <ol start="3"><li>Nginx 找到 nginx.conf 中定义的所有正则匹配（<code>~</code>和<code>~*</code>），并按顺序进行匹配。</li></ol> <ul><li>如果有任何正则表达式匹配成功，则<strong>立即响应</strong></li> <li>如果没有任何正则匹配成功，则响应第 2 步中<strong>存储的 <code>空</code> 修饰符匹配结果</strong>。</li></ul> <h3 id="loaction-其他"><a href="#loaction-其他" class="header-anchor">#</a> loaction 其他</h3> <ol><li><code>@</code> 开头的是用于内部跳转的命名 location。</li> <li>merge_slashes 可以合并 url 中的重复斜杠，除了 base64 编码的格式，其他情况都需要打开</li></ol> <h2 id="典型配置"><a href="#典型配置" class="header-anchor">#</a> 典型配置</h2> <h3 id="源码编译安装到-usr-local-nginx-的-nginx-典型配置"><a href="#源码编译安装到-usr-local-nginx-的-nginx-典型配置" class="header-anchor">#</a> 源码编译安装到 <code>/usr/local/nginx</code> 的 Nginx 典型配置</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment">#user  nobody;  # 定义 Nginx 运行的用户和用户组，默认由 nobody 账号运行，可以不进行设置</span>
<span class="token keyword">worker_processes</span>  <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment"># Nginx 进程数，一般设置为同 CPU 核数一样</span>

<span class="token comment"># Nginx 的错误日志存放目录，后面可以跟日志类型</span>
<span class="token comment"># 全局错误日志定义类型包括：[ debug | info | notice | warn | error | crit ]</span>
<span class="token comment">#error_log  logs/error.log;</span>
<span class="token comment">#error_log  logs/error.log  notice;</span>
<span class="token comment">#error_log  logs/error.log  info;</span>

<span class="token comment">#pid        logs/nginx.pid; # Nginx 服务启动的 pid 存储位置</span>


<span class="token keyword">events</span> <span class="token punctuation">{</span>
    <span class="token comment"># 参考事件模型，use [ kqueue | rtsig | epoll | /dev/poll | select | poll ];</span>
    <span class="token comment"># epoll模型是Linux 2.6以上版本内核中的高性能网络I/O模型，如果跑在FreeBSD上面，就用kqueue模型。</span>
    <span class="token comment">#use epoll;</span>
    <span class="token keyword">worker_connections</span>  <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment"># 每个进程允许最大并发数</span>
<span class="token punctuation">}</span>


<span class="token keyword">http</span> <span class="token punctuation">{</span>  <span class="token comment"># 配置使用最频繁的部分，代理，缓存，日志定义等绝大多数功能和第三方模块的配置都在这里设置</span>
    <span class="token comment"># include 是个主模块指令，可以将配置文件拆分并引用，减少主配置文件的复杂度</span>
    <span class="token keyword">include</span>       mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span> <span class="token comment"># 文件扩展名与类型映射表</span>
    <span class="token keyword">default_type</span>  application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span> <span class="token comment"># 默认文件类型</span>

    <span class="token comment"># 设置日志格式</span>
    <span class="token comment">#log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
    <span class="token comment">#                  '$status $body_bytes_sent &quot;$http_referer&quot; '</span>
    <span class="token comment">#                  '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';</span>

    <span class="token comment">#access_log  logs/access.log  main; # Nginx 访问日志存放位置</span>

    <span class="token keyword">sendfile</span>        on<span class="token punctuation">;</span> <span class="token comment"># 开启高效传输模式</span>
    <span class="token comment">#tcp_nopush     on; # 减少网络报文段的数量，防止网络阻塞</span>
    <span class="token comment">#autoindex on;  # 开启目录列表访问，适合下载服务器</span>

    <span class="token comment">#keepalive_timeout  0;</span>
    <span class="token keyword">keepalive_timeout</span>  <span class="token number">65</span><span class="token punctuation">;</span>  <span class="token comment"># 保持连接的时间，也叫超时时间，单位秒，默认为0</span>

    <span class="token comment">#gzip  on;</span>

    <span class="token keyword">include</span>	<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span> <span class="token comment"># 加载子配置项</span>

    <span class="token keyword">server</span> <span class="token punctuation">{</span>  <span class="token comment"># 配置虚拟主机的相关参数，如域名、IP、端口等</span>
        <span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>  <span class="token comment"># 配置监听的端口</span>
        <span class="token keyword">server_name</span>  localhost<span class="token punctuation">;</span> <span class="token comment"># 配置的域名，可以有多个，用空格隔开</span>

        <span class="token comment">#charset koi8-r;  # 默认编码</span>

        <span class="token comment">#access_log  logs/host.access.log  main;  # 定义本虚拟机的访问日志</span>

        <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
            <span class="token keyword">root</span>   html<span class="token punctuation">;</span>  <span class="token comment"># 网站根目录</span>
            <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>  <span class="token comment"># 默认首页文件</span>
        <span class="token punctuation">}</span>

        <span class="token comment">#error_page  404              /404.html;</span>

        <span class="token comment"># redirect server error pages to the static page /50x.html</span>
        <span class="token comment">#</span>
        <span class="token keyword">error_page</span>   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html<span class="token punctuation">;</span>  <span class="token comment"># 默认50x对应的访问页面</span>
        <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html <span class="token punctuation">{</span>
            <span class="token keyword">root</span>   html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>
        <span class="token comment">#</span>
        <span class="token comment">#location ~ \.php$ {</span>
        <span class="token comment">#    proxy_pass   http://127.0.0.1;</span>
        <span class="token comment">#}</span>

        <span class="token comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
        <span class="token comment">#</span>
        <span class="token comment">#location ~ \.php$ {</span>
        <span class="token comment">#    root           html;</span>
        <span class="token comment">#    fastcgi_pass   127.0.0.1:9000;</span>
        <span class="token comment">#    fastcgi_index  index.php;</span>
        <span class="token comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>
        <span class="token comment">#    include        fastcgi_params;</span>
        <span class="token comment">#}</span>

        <span class="token comment"># deny access to .htaccess files, if Apache's document root</span>
        <span class="token comment"># concurs with nginx's one</span>
        <span class="token comment">#</span>
        <span class="token comment">#location ~ /\.ht {</span>
        <span class="token comment">#    deny  all;</span>
        <span class="token comment">#}</span>
    <span class="token punctuation">}</span>


    <span class="token comment"># another virtual host using mix of IP-, name-, and port-based configuration</span>
    <span class="token comment">#</span>
    <span class="token comment">#server {</span>
    <span class="token comment">#    listen       8000;</span>
    <span class="token comment">#    listen       somename:8080;</span>
    <span class="token comment">#    server_name  somename  alias  another.alias;</span>

    <span class="token comment">#    location / {</span>
    <span class="token comment">#        root   html;</span>
    <span class="token comment">#        index  index.html index.htm;</span>
    <span class="token comment">#    }</span>
    <span class="token comment">#}</span>


    <span class="token comment"># HTTPS server</span>
    <span class="token comment">#</span>
    <span class="token comment">#server {</span>
    <span class="token comment">#    listen       443 ssl;</span>
    <span class="token comment">#    server_name  localhost;</span>

    <span class="token comment">#    ssl_certificate      cert.pem;</span>
    <span class="token comment">#    ssl_certificate_key  cert.key;</span>

    <span class="token comment">#    ssl_session_cache    shared:SSL:1m;</span>
    <span class="token comment">#    ssl_session_timeout  5m;</span>

    <span class="token comment">#    ssl_ciphers  HIGH:!aNULL:!MD5;</span>
    <span class="token comment">#    ssl_prefer_server_ciphers  on;</span>

    <span class="token comment">#    location / {</span>
    <span class="token comment">#        root   html;</span>
    <span class="token comment">#        index  index.html index.htm;</span>
    <span class="token comment">#    }</span>
    <span class="token comment">#}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="yum-安装的-nginx-典型配置"><a href="#yum-安装的-nginx-典型配置" class="header-anchor">#</a> yum 安装的 Nginx 典型配置</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">user</span>  nginx<span class="token punctuation">;</span>                        <span class="token comment"># 运行用户</span>
<span class="token keyword">worker_processes</span>  <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token comment"># Nginx 进程数，一般设置为同 CPU 核数一样</span>
<span class="token keyword">error_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>error<span class="token punctuation">.</span>log warn<span class="token punctuation">;</span>   <span class="token comment"># Nginx 的错误日志存放目录</span>
<span class="token keyword">pid</span>        <span class="token operator">/</span>var<span class="token operator">/</span>run<span class="token operator">/</span>nginx<span class="token punctuation">.</span><span class="token keyword">pid</span><span class="token punctuation">;</span>      <span class="token comment"># Nginx 服务启动时的 pid 存放位置</span>

<span class="token keyword">events</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> epoll<span class="token punctuation">;</span>     <span class="token comment"># 使用epoll的I/O模型(如果你不知道Nginx该使用哪种轮询方法，会自动选择一个最适合你操作系统的)</span>
    <span class="token keyword">worker_connections</span> <span class="token number">1024</span><span class="token punctuation">;</span>   <span class="token comment"># 每个进程允许最大并发数</span>
<span class="token punctuation">}</span>

<span class="token keyword">http</span> <span class="token punctuation">{</span>   <span class="token comment"># 配置使用最频繁的部分，代理、缓存、日志定义等绝大多数功能和第三方模块的配置都在这里设置</span>
    <span class="token comment"># 设置日志模式</span>
    <span class="token keyword">log_format</span>  main  <span class="token string">'$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
                      <span class="token string">'$status $body_bytes_sent &quot;$http_referer&quot; '</span>
                      <span class="token string">'&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;'</span><span class="token punctuation">;</span>

    <span class="token keyword">access_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>   <span class="token comment"># Nginx访问日志存放位置</span>

    <span class="token keyword">sendfile</span>            on<span class="token punctuation">;</span>   <span class="token comment"># 开启高效传输模式</span>
    <span class="token keyword">tcp_nopush</span>          on<span class="token punctuation">;</span>   <span class="token comment"># 减少网络报文段的数量</span>
    <span class="token keyword">tcp_nodelay</span>         on<span class="token punctuation">;</span>
    <span class="token keyword">keepalive_timeout</span>   <span class="token number">65</span><span class="token punctuation">;</span>   <span class="token comment"># 保持连接的时间，也叫超时时间，单位秒</span>
    <span class="token keyword">types_hash_max_size</span> <span class="token number">2048</span><span class="token punctuation">;</span>

    <span class="token keyword">include</span>             <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>      <span class="token comment"># 文件扩展名与类型映射表</span>
    <span class="token keyword">default_type</span>        application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>   <span class="token comment"># 默认文件类型</span>

    <span class="token keyword">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span>   <span class="token comment"># 加载子配置项</span>

    <span class="token keyword">server</span> <span class="token punctuation">{</span>
    	<span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>       <span class="token comment"># 配置监听的端口</span>
    	<span class="token keyword">server_name</span>  localhost<span class="token punctuation">;</span>    <span class="token comment"># 配置的域名</span>

    	<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
    		<span class="token keyword">root</span>   <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span>  <span class="token comment"># 网站根目录</span>
    		<span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>   <span class="token comment"># 默认首页文件</span>
    		<span class="token keyword">deny</span> <span class="token number">172.168</span><span class="token number">.22</span><span class="token number">.11</span><span class="token punctuation">;</span>   <span class="token comment"># 禁止访问的ip地址，可以为all</span>
    		<span class="token keyword">allow</span> <span class="token number">172.168</span><span class="token number">.33</span><span class="token number">.44</span>； <span class="token comment"># 允许访问的ip地址，可以为all</span>
    	<span class="token punctuation">}</span>

    	<span class="token keyword">error_page</span> <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html<span class="token punctuation">;</span>  <span class="token comment"># 默认50x对应的访问页面</span>
    	<span class="token keyword">error_page</span> <span class="token number">400</span> <span class="token number">404</span> error<span class="token punctuation">.</span>html<span class="token punctuation">;</span>   <span class="token comment"># 同上</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="配置中常用指令详细说明"><a href="#配置中常用指令详细说明" class="header-anchor">#</a> 配置中常用指令详细说明</h2> <h3 id="指令介绍"><a href="#指令介绍" class="header-anchor">#</a> 指令介绍</h3> <p>指令是有 Context 的，不同的指令可以应用的 Context 可能也不同。</p> <ul><li>值指令，主要是存储配置项的值，值指令可以合并，继承规则是向上覆盖，即子配置不存在时，直接使用父配置，子配置存在时，直接覆盖父配置。例如 <code>root</code>、<code>access_log</code>、<code>gzip</code> 等指令</li> <li>动作类指令，主要是指定行为，此类指令不可以合并，例如 <code>rewrite</code>、<code>proxy_pass</code> 等指令，这些指令生效阶段一般是 <code>server_rewrite 阶段</code>、<code>rewrite 阶段</code>、<code>content 阶段</code>。</li></ul> <h3 id="main-全局配置"><a href="#main-全局配置" class="header-anchor">#</a> main 全局配置</h3> <ul><li><code>worker_processes 1;</code></li></ul> <p>定义在配置文件顶级 main 部分，worker 角色的工作进程个数。master 进程是接受并分配请求给 worker 处理。这个数值可以简单设置为 CPU 的核数 <code>grep ^processor /proc/cpuinfo | wc -l</code>，也可以是 auto 值。如果开启了 ssl 和 gzip，更应该设置成与逻辑 CPU 数量一样甚至为 2 倍，可以减少 I/O 操作。如果 Nginx 服务器还有其它服务，可以考虑适当减少。</p> <ul><li><code>worker_cpu_affinity 0001 0010 0100 1000;</code></li></ul> <p>定义在 main 部分。在高并发情况下，通过设置 cpu 粘性来降低由于多 CPU 核切换造成的寄存器等现场重建带来的性能损耗。如 worker_cpu_affinity 0001 0010 0100 1000; （四核）。</p> <ul><li><code>use epoll;</code>
写在 events 部分。在 Linux 操作系统下，nginx 默认使用 epoll 事件模型，得益于此，nginx 在 Linux 操作系统下效率相当高。同时 Nginx 在 OpenBSD 或 FreeBSD 操作系统上采用类似于 epoll 的高效事件模型 kqueue。在操作系统不支持这些高效模型时才使用 select。</li></ul> <h3 id="http-配置"><a href="#http-配置" class="header-anchor">#</a> http 配置</h3> <ul><li><p><code>sendfile on;</code></p> <p>开启高效传输模式，sendfile 指令指定 nginx 是否调用 sendfile 函数来输出文件，减少用户空间到内核空间的上下文切换。对于普通应用设为 on，如果用来进行下载等应用磁盘 IO 重负载应用，可设置为 off，以平衡磁盘与网络 I/O 处理速度，降低系统的负载。注意：如果图片显示不正常把这个改成 off。</p></li> <li><p><code>client_max_body_size 10m;</code></p> <p>允许客户端请求的最大单文件字节数。如果有上传较大文件，请设置它的限制值。</p></li></ul> <h3 id="server-虚拟主机"><a href="#server-虚拟主机" class="header-anchor">#</a> server 虚拟主机</h3> <p>http 服务上支持若干虚拟主机。每个虚拟主机对应一个 server 配置项，配置项里面包含该虚拟主机相关的配置。在提供 mail 服务的代理时，也可以建立若干 server，每个 server 通过监听地址或端口来区分。</p> <ul><li><p><code>listen 80;</code></p> <p>监听端口和地址，默认 80，小于 1024 的要以 root 启动，可以只指定端口或者指定地址和端口，例如<code>listen *:80;</code>、<code>listen 127.0.0.1:80</code></p></li> <li><p><code>server_name localhost;</code></p> <p>服务器名，可以设置多个，第一个名字将成为主服务器名称（主域名），服务器名称可以使用 <code>*</code> 代替名称的第一部分或者最后一部分；也可以通过正则匹配（加 <code>~</code> 前缀），还可以使用正则表达式进行捕获。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">server_name</span> example<span class="token punctuation">.</span>com <span class="token operator">*</span><span class="token punctuation">.</span>example<span class="token punctuation">.</span>com www<span class="token punctuation">.</span>example<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h4 id="server-name-扩展"><a href="#server-name-扩展" class="header-anchor">#</a> server_name 扩展</h4> <p>1、<code>server_name</code> 第一个名字作为主域名可以配合 <code>server_name_in_redirect</code>，可以让多个子域名有重定向时，重定向到主域名下。</p> <p>2、 <code>serve_name</code> 可以使用正则表达式的小括号 <code>()</code> 创建变量，并且可以使用尖括号 <code>?&lt;&gt;</code> 来命名变量。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 使用正则，并且创建变量</span>
<span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">server_name</span> <span class="token operator">~</span><span class="token operator">^</span><span class="token punctuation">(</span>www\<span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span>$<span class="token punctuation">;</span>

  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
      <span class="token keyword">root</span> <span class="token operator">/</span>sites<span class="token operator">/</span>$<span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 创建命名变量</span>
<span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">server_name</span> <span class="token operator">~</span><span class="token operator">^</span><span class="token punctuation">(</span>www\<span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token operator">&lt;</span>domain<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span>$<span class="token punctuation">;</span>

  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
      <span class="token keyword">root</span> <span class="token operator">/</span>sites<span class="token operator">/</span><span class="token variable">$domain</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3、 <code>.example.com</code> 可以匹配到 <code>example.com</code> <code>*.example.com</code></p> <p>4、 <code>_</code> 匹配所有域名</p> <p>5、 在某个 server 块下的 server_name 使用 <code>&quot;&quot;</code> 匹配没有传递 Host 头部的请求</p> <h4 id="多个-server-块的匹配顺序"><a href="#多个-server-块的匹配顺序" class="header-anchor">#</a> 多个 server 块的匹配顺序</h4> <ol><li>优先精确匹配，跟 server 块在 nginx.conf 中的顺序无关</li> <li>其次优先匹配 <code>*</code> 在前的泛域名</li> <li>其次优先匹配 <code>*</code> 在后的泛域名</li> <li>其次匹配到正则表达式，匹配顺序是按 nginx.conf 文件中的出现顺序匹配正则表达式域名</li> <li>最后会匹配到 default server，default server 又分为两种情况，第一种是匹配第一个 server 块，另一种情况是如果 <code>listen</code> 指令后面有 <code>default</code> 时，所在的 server 块就是 default server。</li></ol> <h3 id="localtion"><a href="#localtion" class="header-anchor">#</a> localtion</h3> <h4 id="访问控制-allow-deny"><a href="#访问控制-allow-deny" class="header-anchor">#</a> 访问控制 allow/deny</h4> <p>Nginx 的访问控制模块默认就会安装，而且写法简单，可以分别有多个 allow/deny ，允许或禁止某个 ip 或 ip 段访问，依次满足任何一个规则就停止往下匹配。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span>nginx<span class="token operator">-</span>status <span class="token punctuation">{</span>

  <span class="token keyword">allow</span> <span class="token number">192.168</span><span class="token number">.10</span><span class="token number">.100</span><span class="token punctuation">;</span>
  <span class="token keyword">allow</span> <span class="token number">172.29</span><span class="token number">.73</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">;</span>
  <span class="token keyword">deny</span> all<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们也常用 httpd-devel 工具的 htpasswd 来为访问的路径设置登录密码：（<em>此处笔者没有验证</em>）</p> <div class="language- extra-class"><pre class="language-text"><code>htpasswd -c htpasswd admin
New passwd:
Re-type new password:
Adding password for user admin

htpasswd htpasswd admin    //修改admin密码
htpasswd htpasswd sean    //多添加一个认证用户
</code></pre></div><div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span>nginx<span class="token operator">-</span>status <span class="token punctuation">{</span>
  <span class="token comment">#  auth_basic   &quot;NginxStatus&quot;;</span>
  <span class="token comment">#  auth_basic_user_file   /usr/local/nginx-1.6/htpasswd;</span>

  <span class="token keyword">allow</span> <span class="token number">192.168</span><span class="token number">.10</span><span class="token number">.100</span><span class="token punctuation">;</span>
  <span class="token keyword">allow</span> <span class="token number">172.29</span><span class="token number">.73</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">;</span>
  <span class="token keyword">deny</span> all<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样就生成了默认使用 CRYPT 加密的密码文件。打开上面 nginx-status 的两行注释，重启 Nginx 生效。</p> <h4 id="列出目录-autoindex"><a href="#列出目录-autoindex" class="header-anchor">#</a> 列出目录 autoindex</h4> <p>Nginx 默认是不允许列出整个目录的。如果需要此功能，打开 nginx.conf 文件，在 location、server 或 http 部分加入 <code>autoindex on;</code>，另外两个参数最好也加进去：</p> <ul><li><p><code>autoindex_exact_size off;</code></p> <p>默认为 on，显示出文件的确切大小，单位是 bytes。改为 off 后，显示出文件的大概大小，单位是 KB、MB 或者 GB。</p></li> <li><p><code>autoindex_localtime on;</code></p> <p>默认为 off，显示的文件时间为 GMT 时间。改为 on 后，显示的文件时间为文件的服务器时间。</p></li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span>images <span class="token punctuation">{</span>
  <span class="token keyword">root</span>   <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>nginx<span class="token operator">-</span>default<span class="token operator">/</span>images<span class="token punctuation">;</span>
  <span class="token keyword">autoindex</span> on<span class="token punctuation">;</span>
  <span class="token keyword">autoindex_exact_size</span> off<span class="token punctuation">;</span>
  <span class="token keyword">autoindex_localtime</span> on<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="nginx-的-if-判断"><a href="#nginx-的-if-判断" class="header-anchor">#</a> Nginx 的 if 判断</h2> <div class="language- extra-class"><pre class="language-text"><code>if (condition) {
  ……
}
</code></pre></div><p>rewrite 模块提供的，可以用在 server,location 上下文中，如果条件 condition 为真，则执行大括号内的指令；遵循值指令的继承规则</p> <h3 id="括号中的表达式语法"><a href="#括号中的表达式语法" class="header-anchor">#</a> 括号中的表达式语法</h3> <h4 id="普通语法"><a href="#普通语法" class="header-anchor">#</a> 普通语法</h4> <ul><li>当表达式只是一个变量时，如果值为空或任何以 0 开头的字符串都会当做 <code>false</code></li> <li>直接比较变量和内容时，使用 = 或 !=</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">!=</span> POST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">405</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="正则语法"><a href="#正则语法" class="header-anchor">#</a> 正则语法</h4> <ul><li><code>~</code> 和 <code>!~</code> 判断是否匹配正则表达式，区分大小写</li> <li><code>~*</code> 和 <code>!~*</code> 判断是否匹配正则表达式，不区分大小写</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 如果参数中有 id=1 则 301 到指定域名</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$args</span> <span class="token operator">~</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">rewrite</span> <span class="token operator">^</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com permanent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span>test<span class="token punctuation">.</span>html <span class="token punctuation">{</span>
  <span class="token keyword">set</span> <span class="token variable">$name</span> aaa<span class="token punctuation">;</span>
  <span class="token comment"># 如果参数中有 name=xxx 则使用该值</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$args</span> <span class="token operator">~</span><span class="token operator">*</span> name<span class="token operator">=</span><span class="token punctuation">(</span>\w<span class="token operator">+</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">|</span>$<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">set</span> <span class="token variable">$name</span> $<span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># 301 跳转</span>
  <span class="token keyword">rewrite</span> <span class="token operator">^</span> <span class="token operator">/</span><span class="token variable">$name</span><span class="token punctuation">.</span>html permanent<span class="token punctuation">;</span>
  <span class="token comment"># /test.html =&gt; /aaa.html</span>
  <span class="token comment"># /test.html?name=bbb =&gt; /bbb.html</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="文件及目录"><a href="#文件及目录" class="header-anchor">#</a> 文件及目录</h4> <ul><li><code>-f</code> 和 <code>!-f</code> 判断是否存在文件</li> <li><code>-d</code> 和 <code>!-d</code> 判断是否存在目录</li> <li><code>-e</code> 和 <code>!-e</code> 判断是否存在文件、目录、软连接</li> <li><code>-x</code> 和 <code>!-x</code> 判断文件是否可执行</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span>f <span class="token variable">$request_filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">400</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="if-指令出现问题的原因"><a href="#if-指令出现问题的原因" class="header-anchor">#</a> if 指令出现问题的原因</h4> <ul><li>if 指令在 rewrite 阶段执行</li> <li>if {} 块中的配置，会在 if 条件为真时，替换当前请求的配置
<ul><li>if {} 同样向上继承父配置</li> <li>当在 rewrite 阶段顺序执行时，每次 if 为真都会替换当前请求的配置（连续的 if 后面的会覆盖前面的）</li></ul></li> <li>if {} 中的配置，会影响 rewrite 阶段之后的阶段执行</li></ul> <h2 id="error-page-配置"><a href="#error-page-配置" class="header-anchor">#</a> error_page 配置</h2> <p>error_page 指令的语法是 <code>error_page code... [=[response]] uri;</code>，可以使用的上下文是 <code>http,server,location,if in location</code>。</p> <p>例子：</p> <ol><li><code>error_page 404 /404.html;</code></li> <li><code>error_page 500 502 503 504 /50x.html;</code></li> <li><code>error_page 404 =200 /empty.gif</code> 把状态码 404 替换成 200 返回给客户端</li> <li><code>error_page 404 = /404.php;</code></li> <li><code>error_page 403 http://example.com/forbidden.html</code></li> <li><code>error_page 404 =301 http://example.com/notfound.html</code></li> <li>根据 @ 符号进行内部跳转</li></ol> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
  <span class="token keyword">error_page</span> <span class="token number">404</span> <span class="token operator">=</span> @fallback<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">location</span> @fallback <span class="token punctuation">{</span>
  <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>backend<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="nginx-中的配置单位"><a href="#nginx-中的配置单位" class="header-anchor">#</a> Nginx 中的配置单位</h2> <h3 id="时间单位"><a href="#时间单位" class="header-anchor">#</a> 时间单位</h3> <ul><li>ms：毫秒（milliseconds）</li> <li>s：秒（seconds）</li> <li>m：分钟（minutes）</li> <li>h：小时（hours）</li> <li>d：天（days）</li> <li>w：周（weeks）</li> <li>M：月（months，30 days）</li> <li>y：年（years，365 days）</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">expires</span> <span class="token number">3</span>m<span class="token punctuation">;</span>
</code></pre></div><h3 id="空间单位"><a href="#空间单位" class="header-anchor">#</a> 空间单位</h3> <p>默认为字节（bytes）</p> <ul><li>k/K：kilobytes</li> <li>m/M：megabytes</li> <li>g/G：gigabytes</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">client_max_body_size</span> <span class="token number">10</span>m<span class="token punctuation">;</span>
</code></pre></div><h2 id="推荐文档"><a href="#推荐文档" class="header-anchor">#</a> 推荐文档</h2> <ul><li><a href="https://lmjben.github.io/blog/operation-nginx-match.html#nginx-location-%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99" target="_blank" rel="noopener noreferrer">Nginx Location 匹配规则<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/qiqihaobenben/Front-End-Basics/edit/master/docs/server/nginx/config.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/4/2021, 5:59:58 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/server/nginx/command.html" class="prev">
        Nginx 操作命令
      </a></span> <span class="next"><a href="/server/nginx/static.html">
        Nginx 实操-静态资源服务器
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.26ddf859.js" defer></script><script src="/assets/js/2.0a0a1bce.js" defer></script><script src="/assets/js/190.aea451e0.js" defer></script>
  </body>
</html>
