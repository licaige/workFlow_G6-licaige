(window.webpackJsonp=window.webpackJsonp||[]).push([[50],{483:function(s,t,a){s.exports=a.p+"assets/img/nginx1.da63eed0.png"},682:function(s,t,a){"use strict";a.r(t);var n=a(45),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"nginx-实操-静态资源服务器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-实操-静态资源服务器"}},[s._v("#")]),s._v(" Nginx 实操-静态资源服务器")]),s._v(" "),n("h2",{attrs:{id:"静态网站"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#静态网站"}},[s._v("#")]),s._v(" 静态网站")]),s._v(" "),n("p",[s._v("Nginx 可以作为静态资源服务器，当只有静态资源的时候，就可以使用 Nginx 来做服务器，例如，如果一个网站只是静态页面的话，就可以通过类似以下的配置来实现部署一个静态的网站:")]),s._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("log_format")]),s._v("  main  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$remote_addr - $remote_user [$time_local] \"$request\" '")]),s._v("\n                      "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$status $body_bytes_sent \"$http_referer\" '")]),s._v("\n                      "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'"$http_user_agent" "$http_x_forwarded_for"\'')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v("  docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("access_log")]),s._v(" logs"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("access"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log main"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),n("p",[s._v("这样如果访问 "),n("a",{attrs:{href:"http://docs.chenfangxu.com",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://docs.chenfangxu.com"),n("OutboundLink")],1),s._v(" 就会默认访问到 "),n("code",[s._v("usr/local/app")]),s._v(" 目录下面的 "),n("code",[s._v("index.html")]),s._v("。")]),s._v(" "),n("h2",{attrs:{id:"静态目录服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#静态目录服务"}},[s._v("#")]),s._v(" 静态目录服务")]),s._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" static"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("charset")]),s._v(" utf"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 防止中文文件名乱码")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alias")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("static"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 静态资源目录")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("autoindex")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许展示静态资源目录")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("autoindex_exact_size")]),s._v(" off"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# off：显示文件大概大小，单位 KB、MB、GB；on：（默认）显示文件的确切大小，单位是 byte")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("autoindex_localtime")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# off：（默认）显示的文件时间为 GMT 时间；on：显示的文件时间为服务器时间")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),n("p",[s._v("访问 "),n("a",{attrs:{href:"http://static.chenfangxu.com",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://static.chenfangxu.com"),n("OutboundLink")],1),s._v("，就可以看到一个简单的目录。")]),s._v(" "),n("h2",{attrs:{id:"gzip-压缩"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gzip-压缩"}},[s._v("#")]),s._v(" gzip 压缩")]),s._v(" "),n("p",[s._v("使用 gzip 不仅需要 Nginx 配置，浏览器端也需要配合，需要在请求头中包含 "),n("code",[s._v("Accept-Encoding: gzip")]),s._v("（IE5 之后所有的浏览器都支持了，是现代浏览器的默认设置）。一般在请求 html 和 css 等静态资源的时候，支持的浏览器在 request 请求静态资源的时候，会加上 "),n("code",[s._v("Accept-Encoding: gzip")]),s._v(" 这个 header，表示自己支持 gzip 的压缩方式，Nginx 在拿到这个请求的时候，如果有相应配置，就会返回经过 gzip 压缩过的文件给浏览器，并在 response 相应的时候加上 "),n("code",[s._v("content-encoding: gzip")]),s._v(" 来告诉浏览器自己采用的压缩方式（因为浏览器在传给服务器的时候一般还告诉服务器自己支持好几种压缩方式），浏览器拿到压缩的文件后，根据自己的解压方式进行解析。")]),s._v(" "),n("p",[s._v("这个配置可以插入到 http 上下文里，也可以插入到需要使用的虚拟主机的 server 或者下面的 location 上下文中。")]),s._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("access_log")]),s._v(" logs"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("access"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log main"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#默认 off，是否开启gzip")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_types")]),s._v(" text"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("plain text"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("css application"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("json application"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("x"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("javascript text"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("xml application"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("xml application"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("xml"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("rss text"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("javascript"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_static")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_proxied")]),s._v(" any"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_vary")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_comp_level")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_buffers")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_min_length")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_http_version")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("www"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dist"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])])]),n("ul",[n("li",[s._v("gzip_typs：要采用 gzip 压缩的 MIME 文件类型，其中 "),n("code",[s._v("text/html")]),s._v(" 被系统强制启用。")]),s._v(" "),n("li",[s._v("gzip_static：默认为 off，该模块启用后，Nginx 首先检查请求的静态文件是否有 .gz 结尾的文件，如果有，直接返回该 "),n("code",[s._v(".gz")]),s._v(" 文件内容。")]),s._v(" "),n("li",[s._v("gzip_proxied：默认为 off，Nginx 作为反向代理时启用，用于设置启用或禁用从代理服务器收到相应内容 gzip 压缩。")]),s._v(" "),n("li",[s._v("gzip_vary：用于在相应消息头中添加 "),n("code",[s._v("Vary: Accept-Encoding")]),s._v("，使代理服务器根据请求头中的 "),n("code",[s._v("Accept-Encoding")]),s._v("识别是否启用 gzip 压缩。")]),s._v(" "),n("li",[s._v("gzip_comp_level：gzip 压缩比，压缩级别是 1-9，1 压缩级别最低，9 压缩级别最高，级别越高压缩率越高，压缩时间也越长，建议 4 - 6。")]),s._v(" "),n("li",[s._v("gzip_buffers：获取多少内存用于缓存压缩结果， 16 8k 表示以 "),n("code",[s._v("8k * 16")]),s._v(" 为单位获得，以 8k 为单位，按照原始数据大小以 8k 为单位的 16 倍申请内存。")]),s._v(" "),n("li",[s._v("gzip_min_length：允许压缩的页面最小字节数，页面字节数从 header 头中的 "),n("code",[s._v("Content-Length")]),s._v(" 中获取。默认值是 0，不管页面多大都压缩。建议设置成大于 1k 的字节数，小于 1k，可能会越压越大。")]),s._v(" "),n("li",[s._v("gzip_http_version：默认 1.1，启用 gzip 所需的 HTTP 最低版本。")])]),s._v(" "),n("p",[s._v("可以通过网页 GZIP 压缩检测，看一下 "),n("code",[s._v("docs.chenfangxu.com")]),s._v(" 的相关数据。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(483),alt:""}})]),s._v(" "),n("h3",{attrs:{id:"前端项目-gzip-压缩"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前端项目-gzip-压缩"}},[s._v("#")]),s._v(" 前端项目 gzip 压缩")]),s._v(" "),n("p",[s._v("当前端项目使用 Webpack 等打包工具进行打包时，一般都有配置可以开启 gzip 压缩，打包出来的文件会有经过 "),n("code",[s._v("gzip")]),s._v(" 压缩之后的 "),n("code",[s._v(".gz")]),s._v(" 文件。")]),s._v(" "),n("p",[n("strong",[s._v("为什么在 Nginx 已经有了 gzip 压缩，打包工具还需要整个 gzip 呢？")])]),s._v(" "),n("p",[s._v("因为如果全都是使用 Nginx 来压缩文件，会耗费服务器的计算资源，如果 "),n("code",[s._v("gzip_comp_level")]),s._v(" 配置的比较高，就更增加了服务器的开销，相应也会增加客户端的请求时间，得不偿失。")]),s._v(" "),n("p",[s._v("如果压缩在前端打包的时候就做了，把打包之后的高压缩等级文件作为静态资源放在服务器上，Nginx 会优先查找这些压缩之后的文件返回给客户端，相当于把压缩文件的动作从 Nginx 提前到了打包的时候完成， 节约了服务器资源，所以一般推荐在生产环境使用打包工具配置 gzip 压缩。")]),s._v(" "),n("h2",{attrs:{id:"配置-https"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置-https"}},[s._v("#")]),s._v(" 配置 HTTPS")]),s._v(" "),n("p",[s._v("HTTPS 是在应用层 HTTP 之下加入了表示层 SSL(Secure Socket Layer)/TLS(Transport Layer Security)。 Nginx 配置 HTTPS 主要两个步骤："),n("strong",[s._v("签署第三方可信任的 SSL 证书")]),s._v("和"),n("strong",[s._v("配置 HTTPS")]),s._v("。")]),s._v(" "),n("p",[s._v("例如腾讯云申请的免费证书，下载证书压缩文件，解压后把 Nginx 文件夹下的 "),n("code",[s._v("xxx.crt")]),s._v(" 和 "),n("code",[s._v("xxx.key")]),s._v(" 文件拷贝到服务器目录 "),n("code",[s._v("/usr/local/nginx/conf/ssl")]),s._v("。在编译安装的时候添加了 ssl 和 http2 相关的模块，可以直接如下配置：")]),s._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),s._v(" http2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssl 访问端口号为 443，还开启了 http/2.0")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 证书文件地址")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_certificate")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("_docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com_bundle"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("crt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 私钥文件地址")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_certificate_key")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("_docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器优化，减少 CPU 的运算量")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置共享会话缓存大小，1m 大概可以支持 4000 个连接")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_session_cache")]),s._v(" shared"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SSL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置会话超时时间")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_session_timeout")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安全相关")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 优先采取服务器算法")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_prefer_server_ciphers")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用 DH 文件")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_dhparam")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("certs"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dhparam"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 协议版本，限制连接只包含 SSL/TLS 的加强版本")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_protocols")]),s._v(" TLSv1 TLSv1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" TLSv1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义算法，选择要使用的安全套件")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_ciphers")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启用 HSTS。允许 https 网站要求浏览器总是通过 https 来访问")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" Strict"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Transport"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Security "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max-age=31536000; includeSubDomains;preload"')]),s._v(" always"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 减少点击劫持")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" X"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Frame"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Options "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DENY")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁止服务器自动解析资源类型")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" X"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Content"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Type"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Options nosniff"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 防 XSS 攻击")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" X"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Xss"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Protection "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("access_log")]),s._v(" logs"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("access"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log main"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_types")]),s._v(" text"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("plain text"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("css application"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("json application"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("x"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("javascript text"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("xml application"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("xml application"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("xml"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("rss text"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("javascript"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_static")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_proxied")]),s._v(" any"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_vary")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_comp_level")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_buffers")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_min_length")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_http_version")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("www"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dist"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),n("p",[n("code",[s._v("ssl_protocols")]),s._v(" 和 "),n("code",[s._v("ssl_ciphers")]),s._v(" 可以用来限制连接只包含 SSL/TLS 的加强版本和算法，默认值如下：")]),s._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_protocols")]),s._v(" TLSv1 TLSv1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" TLSv1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_ciphers")]),s._v(" HIGH"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("aNULL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("MD5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),n("p",[s._v("由于这两个命令的默认值已经好几次发生了改变，因此不建议显性定义，除非有需要额外定义的值，如定义 D-H 算法：")]),s._v(" "),n("p",[s._v("首先在目录 "),n("code",[s._v("/etc/ssl/certs")]),s._v(" 运行 "),n("code",[s._v("openssl dhparam -out dhparam.pem 2048")]),s._v(" ，生成 "),n("code",[s._v("dhparam.pem")]),s._v(" 文件，然后增加配置：")]),s._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#使用DH文件")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_dhparam")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("certs"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dhparam"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_protocols")]),s._v(" TLSv1 TLSv1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" TLSv1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#定义算法")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_ciphers")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),n("h4",{attrs:{id:"创建证书-自签名证书-chrome-会不允许访问"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建证书-自签名证书-chrome-会不允许访问"}},[s._v("#")]),s._v(" 创建证书（自签名证书 Chrome 会不允许访问）")]),s._v(" "),n("ul",[n("li",[s._v("创建根证书\n"),n("ul",[n("li",[s._v("创建 CA 私钥\n"),n("ul",[n("li",[n("code",[s._v("openssl genrsa -out ca.key 2048")])])])]),s._v(" "),n("li",[s._v("制作 CA 公钥\n"),n("ul",[n("li",[n("code",[s._v("openssl req -new -x509 -days 3650 -key ca.key -out ca.crt")])])])])])]),s._v(" "),n("li",[s._v("签发证书\n"),n("ul",[n("li",[s._v("创建私钥\n"),n("ul",[n("li",[n("code",[s._v("openssl genrsa -out a.pem 1024")])]),s._v(" "),n("li",[n("code",[s._v("openssl rsa -in a.pem -out a.key")])])])]),s._v(" "),n("li",[s._v("生成签发请求\n"),n("ul",[n("li",[n("code",[s._v('openssl req -new -key a.pem -out a.csr -subj "/C=CN/ST=BJ/L=BJ/O=a/OU=a/CN=*.a.com"')])])])]),s._v(" "),n("li",[s._v("使用 CA 证书进行签发\n"),n("ul",[n("li",[n("code",[s._v("openssl x509 -req -sha256 -in a.csr -CA ca.crt -CAkey ca.key -CAcreateserial -days 3650 -out a.crt")])])])]),s._v(" "),n("li",[s._v("验证签发证书是否正确\n"),n("ul",[n("li",[n("code",[s._v("openssl verify -CAfile ca.crt a.crt")])])])])])])]),s._v(" "),n("h3",{attrs:{id:"http-重定向到-https"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#http-重定向到-https"}},[s._v("#")]),s._v(" HTTP 重定向到 HTTPS")]),s._v(" "),n("p",[s._v("之前配置过 "),n("a",{attrs:{href:"http://docs.chenfangxu.com",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://docs.chenfangxu.com"),n("OutboundLink")],1),s._v("，我们可以修改配置，当访问 http 时重定向到 https：")]),s._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("301")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("https")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$server_name")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_uri")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),n("h4",{attrs:{id:"配置文件优化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置文件优化"}},[s._v("#")]),s._v(" 配置文件优化")]),s._v(" "),n("p",[s._v("为了让更多的二级域名支持 https 功能，每个 server 都这么写又太麻烦。可以将 https 相关的 listen、ssl、add_header 相关的单独写在一个文件上，然后使用 "),n("code",[s._v("include")]),s._v(" 指令引入。")]),s._v(" "),n("p",[s._v("新建 conf.custom 文件夹，编写配置 "),n("code",[s._v("vim /usr/local/nginx/conf/conf.custom/https-base.conf")])]),s._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),s._v(" http2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_certificate")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("_docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com_bundle"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("crt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_certificate_key")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("_docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_session_cache")]),s._v(" shared"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SSL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_session_timeout")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_prefer_server_ciphers")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_dhparam")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("certs"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dhparam"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_protocols")]),s._v(" TLSv1 TLSv1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" TLSv1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_ciphers")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" Strict"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Transport"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Security "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max-age=31536000; includeSubDomains;preload"')]),s._v(" always"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" X"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Frame"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Options "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DENY")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" X"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Content"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Type"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Options nosniff"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" X"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Xss"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Protection "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),n("p",[s._v("gzip 也可以同样优化一下")]),s._v(" "),n("p",[n("code",[s._v("vim /usr/local/nginx/conf/conf.custom/gzip-base.conf")])]),s._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_types")]),s._v(" text"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("plain text"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("css application"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("json application"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("x"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("javascript text"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("xml application"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("xml application"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("xml"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("rss text"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("javascript"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_static")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_proxied")]),s._v(" any"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_vary")]),s._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_comp_level")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_buffers")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_min_length")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_http_version")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),n("p",[s._v("之后在 "),n("code",[s._v("/usr/local/nginx/conf/nginx.conf")]),s._v(" 中新增配置：")]),s._v(" "),n("div",{staticClass:"language-nginx extra-class"},[n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("include")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("custom"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("https")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("base"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("include")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("custom"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("base"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("access_log")]),s._v(" logs"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("access"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log main"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("www"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("chenfangxu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dist"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),n("h2",{attrs:{id:"推荐阅读"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#推荐阅读"}},[s._v("#")]),s._v(" 推荐阅读")]),s._v(" "),n("p",[n("a",{attrs:{href:"https://jelly.jd.com/article/6006b1045b6c6a01506c87b5",target:"_blank",rel:"noopener noreferrer"}},[s._v("Nginx 配置 HTTPS 服务器"),n("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=e.exports}}]);