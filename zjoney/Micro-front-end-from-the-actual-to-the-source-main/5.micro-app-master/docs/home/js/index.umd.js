!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@babel/runtime/helpers/typeof")):"function"==typeof define&&define.amd?define(["exports","@babel/runtime/helpers/typeof"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).microApp={})}(this,(function(e){"use strict";function t(e){return"string"==typeof e?`[micro-app] ${e}`:e}function n(e,...t){Promise.resolve().then(e.bind(null,...t))}function o(e){if("string"!=typeof e||!e)return"";try{const{origin:t,pathname:n}=new URL(e.startsWith("//")?`${location.protocol}${e}`:e),o=`${t}${n}/`.replace(/\/\/$/,"/");return/^https?:\/\//.test(o)?o:""}catch(e){return console.error(e),""}}function r(e,t){if(/^((((ht|f)tps?)|file):)?\/\//.test(e))return e;const{origin:n}=new URL(t);return new URL(e,n).toString()}function i(e,t,n,o){let r=0;function i(){++r===e.length&&o()}e.forEach(((e,o)=>{"[object Promise]"===toString.call(e)?e.then((e=>{t({data:e,index:o}),i()})).catch((e=>{n({error:e,index:o}),i()})):(t({data:e,index:o}),i())}))}const s=window.requestIdleCallback||function(e){const t=Date.now();return setTimeout((function(){e({didTimeout:!1,timeRemaining:()=>Math.max(0,50-(Date.now()-t))})}),1)};let c=null;function a(e){c=e}function l(){return c}function u(){return/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)}function p(e,t){return a(null),document.createElement(e,t)}var d,h,m,f;function y(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))}function b(e){return fetch(e).then((e=>e.text())).catch((e=>{throw e}))}function g(e,t){const{selectorText:n,cssText:o}=e;if(/^(html[\s+>~,]+body)|(html|body|:root)$/.test(n))return o.replace(/^(html[\s+>~,]+body)|(html|body|:root)/,t);if("*"===n)return o.replace("*",`${t} *`);const r=/(^|\s+)((html[\s+>~]+body)|(html|body|:root))(?=[\s+>~]+|$)/;return o.replace(/^[\s\S]+{/,(e=>e.replace(/(^|,)([^,]+)/g,((e,n,o)=>r.test(o)?e.replace(r,t):`${n} ${t} ${o.replace(/^\s*/,"")}`))))}function w(e,t,n){const o=E(Array.from(e.cssRules),t);return`@${n} ${e.conditionText} {${o}}`}function E(e,t){let n="";for(const o of e)switch(o.type){case f.STYLE_RULE:n+=g(o,t);break;case f.MEDIA_RULE:n+=w(o,t,"media");break;case f.SUPPORTS_RULE:n+=w(o,t,"supports");break;default:n+=o.cssText}return n}function v(e,t,n,o,i){var s,c;e.textContent=n;let a=function(e,t,n){return e.replace(/url\(["']?([^)"']+)["']?\)/gm,((e,o)=>{if(/^data:/.test(o))return e;if(/^(https?:)?\/\//.test(o)){if(!u())return e;{const t=o.replace(/^https?:/,"");if(-1!==n.indexOf(t))return e;o=o.replace(window.location.origin,"")}}return`url("${r(o,t)}")`}))}(E(Array.from(null!==(c=null===(s=e.sheet)||void 0===s?void 0:s.cssRules)&&void 0!==c?c:[]),o),i,n);u()&&(a=a.replace(/([;{]\s*content:\s*)([^\s"][^";}]*)/gm,((e,t,n)=>"none"===n||/^(url\()|(counter\()|(attr\()|(open-quote)|(close-quote)/.test(n)?e:`${t}"${n}"`))),t.textContent=a,e.textContent=""}let O;function _(e,t){var n;const o=de.get(t);if(null==o?void 0:o.scopecss){const r=`micro-app[name=${t}]`;O||(O=p("style"),document.body.appendChild(O),O.sheet.disabled=!0);const i=null!==(n=e.textContent)&&void 0!==n?n:"";if(i)v(O,e,i,r,o.url);else{const t=new MutationObserver((function(){var n;v(O,e,null!==(n=e.textContent)&&void 0!==n?n:"",r,o.url),t.disconnect()}));t.observe(e,{childList:!0})}}return e}function D(e,t){Object.defineProperties(e,{currcurrentTarget:{get:()=>t},srcElement:{get:()=>t},target:{get:()=>t}})}function C(e){const t=new CustomEvent("load");D(t,e),"function"==typeof e.onload?e.onload(t):e.dispatchEvent(t)}function A(e){const t=new CustomEvent("error");D(t,e),"function"==typeof e.onerror?e.onerror(t):e.dispatchEvent(t)}!function(e){e.NAME="name",e.URL="url"}(d||(d={})),function(e){e.NOT_LOADED="NOT_LOADED",e.LOADING_SOURCE_CODE="LOADING_SOURCE_CODE",e.LOAD_SOURCE_FINISHED="LOAD_SOURCE_FINISHED",e.LOAD_SOURCE_ERROR="LOAD_SOURCE_ERROR",e.MOUNTING="MOUNTING",e.MOUNTED="MOUNTED",e.UNMOUNT="UNMOUNT"}(h||(h={})),function(e){e.BEFOREMOUNT="beforemount",e.MOUNTED="mounted",e.UNMOUNT="unmount",e.ERROR="error"}(m||(m={})),function(e){e[e.STYLE_RULE=1]="STYLE_RULE",e[e.MEDIA_RULE=4]="MEDIA_RULE",e[e.SUPPORTS_RULE=12]="SUPPORTS_RULE"}(f||(f={}));const S=new Map;function N(e,t,n,o,i=!1){const s=e.getAttribute("rel");let c=e.getAttribute("href"),a=null;if("stylesheet"===s&&c){if(c=r(c,n.url),i)return{url:c,info:{code:"",isGlobal:e.hasAttribute("global")}};{a=document.createComment(`the link with href=${c} move to micro-app-head as style element`);const t=document.createComment(`placeholder for link with href=${c}`);o.appendChild(t),n.source.links.set(c,{code:"",placeholder:t,isGlobal:e.hasAttribute("global")})}}else c&&e.setAttribute("href",r(c,n.url));return i?{replaceComment:a}:a?t.replaceChild(a,e):void 0}function x(e,n,o){const r=Array.from(n.source.links.entries()),s=[];for(const[e]of r){const t=S.get(e);t?s.push(t):s.push(b(e))}i(s,(e=>{!function(e,n,o,r,i){o||console.warn(t(`data fetch from url ${e} is empty`));n.isGlobal&&!S.has(e)&&S.set(e,o);const s=document.createElement("style");s.textContent=o,r.replaceChild(_(s,i.name),n.placeholder),n.placeholder=null,n.code=o}(r[e.index][0],r[e.index][1],e.data,o,n)}),(e=>{console.error("[micro-app]",e)}),(()=>{n.onLoad(e)}))}const R=new Map,L="noModule"in document.createElement("script");function M(e,t,n,o=!1){let i=null,s=e.getAttribute("src");if(e.hasAttribute("exclude"))i=document.createComment("script element with exclude attribute ignored by micro-app");else if(L&&e.noModule||!L&&"module"===e.type)i=document.createComment((e.noModule?"noModule":"module")+" script ignored by micro-app");else if(s){s=r(s,n.url);const t={code:"",isExternal:!0,isDynamic:o,async:e.hasAttribute("async"),defer:e.defer||"module"===e.type,module:"module"===e.type,isGlobal:e.hasAttribute("global")};if(o)return{url:s,info:t};n.source.scripts.set(s,t),i=document.createComment(`script with src='${s}' extract by micro-app`)}else if(e.textContent){const t=Math.random().toString(36).substr(2,15),r={code:e.textContent,isExternal:!1,isDynamic:o,async:!1,defer:"module"===e.type,module:"module"===e.type};if(o)return{url:t,info:r};n.source.scripts.set(t,r),i=document.createComment("inline script extract by micro-app")}else i=document.createComment("script ignored by micro-app");return o?{replaceComment:i}:t.replaceChild(i,e)}function P(e,n){const o=Array.from(n.source.scripts.entries()),r=[],s=[];for(const[e,t]of o)if(t.isExternal){const n=R.get(e);n?t.code=n:t.defer||t.async||(r.push(b(e)),s.push([e,t]))}r.length?i(r,(e=>{!function(e,n,o){o||console.warn(t(`data fetch from url ${e} is empty`));n.isGlobal&&!R.has(e)&&R.set(e,o);n.code=o}(s[e.index][0],s[e.index][1],e.data)}),(e=>{console.error("[micro-app]",e)}),(()=>{n.onLoad(e)})):n.onLoad(e)}function U(e,t,n,o){var r;try{if(e=T(e,t),t.inline){const n=p("script");if(n.textContent=e,o)return n;null===(r=t.container)||void 0===r||r.querySelector("micro-app-body").appendChild(n)}else if((0,eval)(e),o)return document.createComment("dynamic script extract by micro-app")}catch(e){console.error("[micro-app from runScript]",e)}}function T(e,t){if(t.useSandbox){return(0,eval)("window").proxyWindow=t.sandBox.proxyWindow,`;(function(window, self){with(window){;${e}\n}}).call(window.proxyWindow, window.proxyWindow, window.proxyWindow);`}return e}function $(e,t,n){const o=Array.from(e.children);o.length&&o.forEach((e=>{$(e,t,n)}));for(const i of o)i instanceof HTMLLinkElement?i.hasAttribute("exclude")?e.replaceChild(document.createComment("link element with exclude attribute ignored by micro-app"),i):t.scopecss?N(i,e,t,n):i.hasAttribute("href")&&i.setAttribute("href",r(i.getAttribute("href"),t.url)):i instanceof HTMLStyleElement?i.hasAttribute("exclude")?e.replaceChild(document.createComment("style element with exclude attribute ignored by micro-app"),i):t.scopecss&&n.appendChild(_(i,t.name)):i instanceof HTMLScriptElement?M(i,e,t):i instanceof HTMLMetaElement||i instanceof HTMLTitleElement?e.removeChild(i):/^(img|iframe)$/i.test(i.tagName)&&i.hasAttribute("src")?i.setAttribute("src",r(i.getAttribute("src"),t.url)):/^a$/i.test(i.tagName)&&i.hasAttribute("href")&&i.setAttribute("href",r(i.getAttribute("href"),t.url))}function j(e,n){const o=function(e){const t=document.createElement("div");return t.innerHTML=e,t}(e),r=o.querySelector("micro-app-head"),i=o.querySelector("micro-app-body");if(!r||!i){const e=`element ${r?"body":"head"} is missing`;return n.onerror(new Error(e)),console.error(t(e))}$(o,n,r),n.source.links.size?x(o,n,r):n.onLoad(o),n.source.scripts.size?P(o,n):n.onLoad(o)}const k=Object.defineProperty;const I="function"==typeof document.all&&void 0===document.all?e=>"function"==typeof e&&void 0!==e:e=>"function"==typeof e,W=new WeakMap;const B=new WeakMap;const G=new WeakMap;function q(e,t){const n=G.get(t);if(n)return n;if(I(t)&&!function(e){if(W.has(e))return W.get(e);const t=0===e.name.indexOf("bound ")&&!e.hasOwnProperty("prototype");return W.set(e,t),t}(t)&&!function(e){if(B.has(e))return B.get(e);const t=e.prototype&&e.prototype.constructor===e&&Object.getOwnPropertyNames(e.prototype).length>1||/^function\b\s[A-Z].*/.test(e.toString())||/^class\b/.test(e.toString());return B.set(e,t),t}(t)){const n=Function.prototype.bind.call(t,e);for(const e in t)n[e]=t[e];return t.hasOwnProperty("prototype")&&!n.hasOwnProperty("prototype")&&(n.prototype=t.prototype),G.set(t,n),n}return t}const H=window.addEventListener,F=window.removeEventListener,z=window.setInterval,K=window.setTimeout,Y=window.clearInterval,J=window.clearTimeout;function V(e,t){return"unmount"===e?`unmount-${t.__micro_app_name__}`:e}const Z=new class{constructor(){this.eventList=new Map}isLegalName(e){return!("string"!=typeof e||!e)||(console.error(t("event-center: Invalid name")),!1)}on(e,n){if(this.isLegalName(e)){if("function"!=typeof n)return console.error(t("event-center: Invalid callback function"));let o=this.eventList.get(e);o?Object.getOwnPropertyNames(o.data).length&&n(o.data):(o={data:{},callbacks:new Set},this.eventList.set(e,o)),o.callbacks.add(n)}}off(e,t){if(this.isLegalName(e)){const n=this.eventList.get(e);n&&("function"==typeof t?n.callbacks.delete(t):t||n.callbacks.clear())}}dispatch(e,n){if(this.isLegalName(e)){if("[object Object]"!==toString.call(n))return console.error(t("event-center: data must be object"));let o=this.eventList.get(e);if(o){if(o.data!==n){o.data=n;for(const e of o.callbacks)e(n)}}else o={data:n,callbacks:new Set},this.eventList.set(e,o)}}getData(e){var t;const n=this.eventList.get(e);return null!==(t=null==n?void 0:n.data)&&void 0!==t?t:null}};function Q(e,t){return"string"==typeof e&&e?t?`__from_base_app_${e}__`:`__from_micro_app_${e}__`:""}class X{addGlobalDataListener(e){Z.on("global",e)}removeGlobalDataListener(e){"function"==typeof e&&Z.off("global",e)}setGlobalData(e){Z.dispatch("global",e)}clearGlobalDataListener(){Z.off("global")}}class ee extends X{addDataListener(e,t){Z.on(Q(e,!1),t)}removeDataListener(e,t){"string"==typeof e&&"function"==typeof t&&Z.off(Q(e,!1),t)}getData(e,t=!1){return Z.getData(Q(e,t))}setData(e,t){Z.dispatch(Q(e,!0),t)}clearDataListener(e){Z.off(Q(e,!1))}}class te extends X{constructor(e){super(),this.appName=e}addDataListener(e){Z.on(Q(this.appName,!0),e)}removeDataListener(e){"function"==typeof e&&Z.off(Q(this.appName,!0),e)}getData(){return Z.getData(Q(this.appName,!0))}dispatch(e){n((()=>{Z.dispatch(Q(this.appName,!1),e);const t=de.get(this.appName);if((null==t?void 0:t.container)&&"[object Object]"===toString.call(e)){const n=new CustomEvent("datachange",{detail:{data:e}});t.container.dispatchEvent(n)}}))}clearDataListener(){Z.off(Q(this.appName,!0))}}const ne=["System","__cjsWrapper","__REACT_ERROR_OVERLAY_GLOBAL_HOOK__"],oe=["location"],re={undefined:!0,Array:!0,Object:!0,String:!0,Boolean:!0,Math:!0,Number:!0,Symbol:!0,parseFloat:!0,Float32Array:!0};let ie;function se(e){ie&&clearTimeout(ie),ie=setTimeout(e,0)}class ce{constructor(e,t,o){this.active=!1;const r=window,{clonedWindow:i,propertiesWithGetter:s}=function(e,t){const n={},o=new Map;return Object.getOwnPropertyNames(e).forEach((t=>{const r=Object.getOwnPropertyDescriptor(e,t);if(r&&!r.configurable){const e=Object.prototype.hasOwnProperty.call(r,"get");"top"!==t&&"parent"!==t&&"self"!==t&&"window"!==t||(r.configurable=!0,e||(r.writable=!0)),e&&o.set(t,!0),k(n,t,Object.freeze(r))}})),{clonedWindow:n,propertiesWithGetter:o}}(window),c=new Map,l=e=>i.hasOwnProperty(e)||r.hasOwnProperty(e);this.inject(i,e,t),this.releaseEffect=function(e){const t=new Map,n=new Set,o=new Set;return e.addEventListener=function(n,o,r){n=V(n,e);const i=t.get(n);return i?i.add(o):t.set(n,new Set([o])),H.call(window,n,o,r)},e.removeEventListener=function(n,o,r){n=V(n,e);const i=t.get(n);return(null==i?void 0:i.size)&&i.has(o)&&i.delete(o),F.call(window,n,o,r)},e.setInterval=function(e,t,...o){const r=z(e,t,...o);return n.add(r),r},e.setTimeout=function(e,t,...n){const r=K(e,t,...n);return o.add(r),r},e.clearInterval=function(e){n.delete(e),Y(e)},e.clearTimeout=function(e){o.delete(e),J(e)},()=>{t.size&&(t.forEach(((e,t)=>{if(e.size)for(const n of e)F.call(window,t,n)})),t.clear()),n.size&&(n.forEach((e=>{Y(e)})),n.clear()),o.size&&(o.forEach((e=>{J(e)})),o.clear())}}(i),this.proxyWindow=new Proxy(i,{get:(t,i)=>{if(i===Symbol.unscopables)return re;if("window"===i||"self"===i)return this.proxyWindow;if("top"===i||"parent"===i)return r===r.parent?this.proxyWindow:Reflect.get(r,i);if("hasOwnProperty"===i)return l;if("document"===i||"eval"===i)switch(a(e),(o?se:n)((()=>a(null))),i){case"document":return document;case"eval":return eval}if("webpackJsonp"===i)return Reflect.get(t,i);const c=s.get(i)?Reflect.get(r,i):i in t?Reflect.get(t,i):Reflect.get(r,i);return q(r,c)},set:(e,t,n)=>{if(this.active){if(oe.includes(t))Reflect.set(r,t,n);else if(!e.hasOwnProperty(t)&&r.hasOwnProperty(t)&&"webpackJsonp"!==t){const o=Object.getOwnPropertyDescriptor(r,t),{writable:i,configurable:s,enumerable:c}=o;i&&Object.defineProperty(e,t,{configurable:s,enumerable:c,writable:i,value:n})}else Reflect.set(e,t,n);ne.includes(t)&&Reflect.set(r,t,n)}return!0},has:(e,t)=>t in re||t in e||t in r,getOwnPropertyDescriptor(e,t){if(e.hasOwnProperty(t)){const n=Object.getOwnPropertyDescriptor(e,t);return c.set(t,"target"),n}if(r.hasOwnProperty(t)){const e=Object.getOwnPropertyDescriptor(r,t);return c.set(t,"rawWindow"),e&&!e.configurable&&(e.configurable=!0),e}},defineProperty:(e,t,n)=>"rawWindow"===c.get(t)?Reflect.defineProperty(r,t,n):Reflect.defineProperty(e,t,n),ownKeys:e=>Reflect.ownKeys(r).concat(Reflect.ownKeys(e)).filter((function(e){return!(e in this)&&(this[e]=!0)}),Object.create(null)),deleteProperty:(e,t)=>!e.hasOwnProperty(t)||Reflect.deleteProperty(e,t)})}start(){this.active||(this.active=!0,ce.activeCount++)}stop(){this.active&&(this.active=!1,this.releaseEffect(),this.proxyWindow.microApp.clearDataListener(),0==--ce.activeCount&&ne.forEach((e=>{this.proxyWindow.hasOwnProperty(e)&&delete window[e]})))}inject(e,t,n){e.__micro_app_environment__=!0,e.__micro_app_name__=t,e.__full_public_path__=n,e.microApp=new te(t)}}function ae(e,t){"[object Array]"===toString.call(e)&&e.forEach((e=>{"[object Object]"===toString.call(e)&&e.name&&"string"==typeof e.name&&e.url&&"string"==typeof e.url&&!de.has(e.name)&&t.push(e)}))}function le(e){s((()=>{const t=[];ae("function"==typeof e?e():e,t),t.forEach((e=>{var t,n,o;const r=new he({name:e.name,url:e.url,scopecss:!(null!==(t=e.disableScopecss)&&void 0!==t?t:ue.disableScopecss),useSandbox:!(null!==(n=e.disableSandbox)&&void 0!==n?n:ue.disableSandbox),macro:null!==(o=e.macro)&&void 0!==o?o:ue.macro});r.isPrefetch=!0,de.set(e.name,r)}))}))}ce.activeCount=0;var ue=new class extends ee{constructor(){super(...arguments),this.version="0.0.5",this.preFetch=le}use(e){"[object Object]"===toString.call(e)&&(this.shadowDOM=e.shadowDOM,this.destory=e.destory,this.inline=e.inline,this.disableScopecss=e.disableScopecss,this.disableSandbox=e.disableSandbox,this.macro=e.macro,"[object Object]"===toString.call(e.lifeCycles)&&(this.lifeCycles=e.lifeCycles),e.preFetchApps&&le(e.preFetchApps))}};function pe(e,n,o,r){var i;if(!e)return console.error(t(`element does not exist in lifecycle ${o}，it seems to be something wrong`));const s=Object.assign({name:n,container:e},r&&{error:r}),c=new CustomEvent(o,{detail:s});!function(e,t){Object.defineProperties(e,{currcurrentTarget:{get:()=>t},target:{get:()=>t}})}(c,e),"function"==typeof(null===(i=ue.lifeCycles)||void 0===i?void 0:i[o])&&ue.lifeCycles[o](c),e.dispatchEvent(c)}const de=new Map;class he{constructor({name:e,url:t,container:n,inline:o,scopecss:r,useSandbox:i,macro:s}){this.status=h.NOT_LOADED,this.loadSourceLevel=0,this.isPrefetch=!1,this.container=null,this.scopecss=!0,this.useSandbox=!0,this.macro=!1,this.sandBox=null,this.container=null!=n?n:null,this.inline=null!=o&&o,this.name=e,this.url=t,this.useSandbox=null==i||i,this.scopecss=!!this.useSandbox&&(null==r||r),this.macro=null!=s&&s,this.source={links:new Map,scripts:new Map},this.loadSourceCode(),this.useSandbox&&(this.sandBox=new ce(e,t,this.macro))}loadSourceCode(){this.status=h.LOADING_SOURCE_CODE,function(e){y(this,void 0,void 0,(function*(){try{let n=yield b(e.url);if(!n){const n="html is empty, please check that the URL is correct";return e.onerror(new Error(n)),console.error(t(n))}n=n.replace(/<head[^>]*>[\s\S]*?<\/head>/i,(e=>e.replace(/<head/i,"<micro-app-head").replace(/<\/head>/i,"</micro-app-head>"))).replace(/<body[^>]*>[\s\S]*?<\/body>/i,(e=>e.replace(/<body/i,"<micro-app-body").replace(/<\/body>/i,"</micro-app-body>"))),j(n,e)}catch(n){e.onLoadError(n),console.error(t(`Failed to fetch data from ${e.url}, micro-app stop rendering`),n)}}))}(this)}onLoad(e){if(2==++this.loadSourceLevel){if(this.source.html=e,this.isPrefetch||this.status===h.UNMOUNT)return;this.status=h.LOAD_SOURCE_FINISHED,this.mount()}}onLoadError(e){this.loadSourceLevel=-1,this.status!==h.UNMOUNT&&(this.onerror(e),this.status=h.LOAD_SOURCE_ERROR)}mount(e,t){var n;if(!this.container&&e&&(this.container=e),"boolean"==typeof t&&t!==this.inline&&(this.inline=t),2!==this.loadSourceLevel)return void(this.status=h.LOADING_SOURCE_CODE);this.status=h.MOUNTING,pe(this.container,this.name,m.BEFOREMOUNT);const o=this.source.html.cloneNode(!0),r=document.createDocumentFragment();Array.from(o.childNodes).forEach((e=>{r.appendChild(e)})),this.container.appendChild(r),null===(n=this.sandBox)||void 0===n||n.start(),function(e,t){const n=Array.from(e.entries()),o=[],r=[];for(const[e,i]of n)i.isDynamic||(i.defer||i.async?(i.isExternal?o.push(b(e)):o.push(i.code),r.push(i)):U(i.code,t,i.module,!1));o.length&&Promise.all(o).then((e=>{e.forEach(((e,n)=>{U(e,t,r[n].module,!1)}))})).catch((e=>{console.error("[micro-app]",e)}))}(this.source.scripts,this),this.status=h.MOUNTED,pe(this.container,this.name,m.MOUNTED)}unmount(e){var t;this.status===h.LOAD_SOURCE_ERROR&&(e=!0),this.status=h.UNMOUNT,pe(this.container,this.name,m.UNMOUNT),function(e){const t=new CustomEvent(`unmount-${e}`);window.dispatchEvent(t)}(this.name),null===(t=this.sandBox)||void 0===t||t.stop(),a(null),this.container=null,e&&de.delete(this.name)}onerror(e){pe(this.container,this.name,m.ERROR,e)}getAppStatus(){return this.status}}const me=Element.prototype.setAttribute,fe=Node.prototype.appendChild,ye=Node.prototype.insertBefore,be=Node.prototype.replaceChild,ge=Node.prototype.removeChild,we=Document.prototype.createElement,Ee=Document.prototype.createElementNS,ve=Document.prototype.createDocumentFragment,Oe=Document.prototype.querySelector,_e=Document.prototype.querySelectorAll,De=Document.prototype.getElementById,Ce=Document.prototype.getElementsByClassName,Ae=Document.prototype.getElementsByName,Se=new WeakMap;function Ne(e,t,n){if(t instanceof HTMLStyleElement){if(t.hasAttribute("exclude")){const e=document.createComment("style element with exclude attribute ignored by micro-app");return Se.set(t,e),e}return n.scopecss?_(t,n.name):t}if(t instanceof HTMLLinkElement){if(t.hasAttribute("exclude")){const e=document.createComment("link element with exclude attribute ignored by micro-app");return Se.set(t,e),e}if(!n.scopecss)return t;const{replaceComment:o,url:r,info:i}=N(t,e,n,null,!0);if(r&&i){const e=p("style");return function(e,t,n,o,r){if(n.source.links.has(e))return r.textContent=n.source.links.get(e).code,void _(r,n.name);if(S.has(e)){const o=S.get(e);return t.code=o,n.source.links.set(e,t),r.textContent=o,void _(r,n.name)}b(e).then((i=>{t.code=i,n.source.links.set(e,t),t.isGlobal&&S.set(e,i),r.textContent=i,_(r,n.name),C(o)})).catch((e=>{console.error("[micro-app]",e),A(o)}))}(r,i,n,t,e),Se.set(t,e),e}return o?(Se.set(t,o),o):t}if(t instanceof HTMLScriptElement){const{replaceComment:o,url:r,info:i}=M(t,e,n,!0);if(r&&i){if(i.code){const e=U(i.code,n,i.module,!0);return Se.set(t,e),e}{const e=function(e,t,n,o){if(n.source.scripts.has(e))return U(n.source.scripts.get(e).code,n,t.module,!0);if(R.has(e)){const o=R.get(e);return t.code=o,n.source.scripts.set(e,t),U(o,n,t.module,!0)}let r;return r=n.inline?p("script"):document.createComment(`dynamic script with src='${e}' extract by micro-app`),b(e).then((i=>{t.code=i,n.source.scripts.set(e,t),t.isGlobal&&R.set(e,i);try{i=T(i,n),n.inline?r.textContent=i:(0,eval)(i)}catch(e){console.error("[micro-app from runDynamicScript]",e)}C(o)})).catch((e=>{console.error("[micro-app]",e),A(o)})),r}(r,i,n,t);return Se.set(t,e),e}}return Se.set(t,o),o}return t}function xe(e,t,n,o,r){if(n instanceof HTMLHeadElement){const n=e.container.querySelector("micro-app-head");return r&&!n.contains(r)?fe.call(n,o):t.call(n,o,r)}if(n instanceof HTMLBodyElement){const n=e.container.querySelector("micro-app-body");return r&&!n.contains(r)?fe.call(n,o):t.call(e.container.querySelector("micro-app-body"),o,r)}return t.call(n,o,r)}function Re(e){var t;return null!==(t=Se.get(e))&&void 0!==t?t:e}function Le(e,t,n,o,r){if(null==t?void 0:t._MICRO_APP_NAME_){const i=de.get(t._MICRO_APP_NAME_);return(null==i?void 0:i.container)?xe(i,r,e,Ne(e,t,i),n&&Re(n)):o}return r.call(e,t,n)}function Me(){!function(){function e(e){var t,n,o;const r=l();return r&&"head"!==e&&"body"!==e?null!==(o=null===(n=null===(t=de.get(r))||void 0===t?void 0:t.container)||void 0===n?void 0:n.querySelector(e))&&void 0!==o?o:null:Oe.call(document,e)}function t(e){var t,n,o;const r=l();return r&&"head"!==e&&"body"!==e?null!==(o=null===(n=null===(t=de.get(r))||void 0===t?void 0:t.container)||void 0===n?void 0:n.querySelectorAll(e))&&void 0!==o?o:[]:_e.call(document,e)}Document.prototype.createElement=function(e,t){return Pe(we.call(document,e,t))},Document.prototype.createElementNS=function(e,t,n){return Pe(Ee.call(document,e,t,n))},Document.prototype.createDocumentFragment=function(){return Pe(ve.call(document))},Document.prototype.querySelector=e,Document.prototype.querySelectorAll=t,Document.prototype.getElementById=function(t){return e(`#${t}`)},Document.prototype.getElementsByClassName=function(e){return t(`.${e}`)},Document.prototype.getElementsByName=function(e){return t(`[name=${e}]`)}}(),Element.prototype.setAttribute=function(e,n){if("MICRO-APP"===this.tagName&&"data"===e)if("[object Object]"===toString.call(n)){const e={};Object.getOwnPropertyNames(n).forEach((t=>{"string"==typeof t&&0===t.indexOf("__")||(e[t]=n[t])})),this.data=e}else"[object Object]"!==n&&console.warn(t("property data must be an object"));else if(("src"===e&&/^(img|iframe|script|style)$/i.test(this.tagName)||"href"===e&&/^(link|a)$/i.test(this.tagName))&&this._MICRO_APP_NAME_&&de.has(this._MICRO_APP_NAME_)){const t=de.get(this._MICRO_APP_NAME_);me.call(this,e,r(n,t.url))}else me.call(this,e,n)},Node.prototype.appendChild=function(e){return Le(this,e,null,e,fe)},Node.prototype.insertBefore=function(e,t){return Le(this,e,t,e,ye)},Node.prototype.replaceChild=function(e,t){return Le(this,e,t,t,be)},Node.prototype.removeChild=function(e){if(null==e?void 0:e._MICRO_APP_NAME_){const t=de.get(e._MICRO_APP_NAME_);return(null==t?void 0:t.container)?xe(t,ge,this,Re(e)):e}return ge.call(this,e)}}function Pe(e){const t=l();return t&&(e._MICRO_APP_NAME_=t),e}function Ue(){Document.prototype.createElement=we,Document.prototype.createElementNS=Ee,Document.prototype.createDocumentFragment=ve,Document.prototype.querySelector=Oe,Document.prototype.querySelectorAll=_e,Document.prototype.getElementById=De,Document.prototype.getElementsByClassName=Ce,Document.prototype.getElementsByName=Ae,Element.prototype.setAttribute=me,Node.prototype.appendChild=fe,Node.prototype.insertBefore=ye,Node.prototype.removeChild=ge,Node.prototype.replaceChild=be}let Te=!1;class $e extends HTMLElement{constructor(){super(),this.name="",this.url="",this.isWating=!1,this.cacheData=null,this.handleAttributeUpdate=()=>{this.isWating=!1;const e=this.getAttribute("name"),n=o(this.getAttribute("url"));if(this.legalAttribute("name",e)&&this.legalAttribute("url",n)){if(e!==this.name&&de.has(e)){if(de.get(e).getAppStatus()!==h.UNMOUNT)return this.setAttribute("name",this.name),console.error(t(`an app named ${this.name} already exists`))}e===this.name&&n===this.url||(this.handleUnmount(!0),this.name=e,this.url=n,this.innerHTML="",this.handleCreate())}else e!==this.name&&this.setAttribute("name",this.name)},1==++$e.microAppCount&&(Me(),function(){if(!Te){Te=!0;const e=document.createElement("style");e.setAttribute("type","text/css"),e.textContent="micro-app, micro-app-body { display: block; }",document.head.appendChild(e)}}())}static get observedAttributes(){return["name","url"]}connectedCallback(){if(!this.name||!this.url)return;const e=de.get(this.name);if(e)return e.url!==this.url||!e.isPrefetch&&e.getAppStatus()!==h.UNMOUNT?e.isPrefetch?console.error(t(`the url: ${this.url} is different from prefetch url: ${e.url}`)):console.error(t(`an app named ${this.name} already exists`)):(e.isPrefetch=!1,n((()=>{var t;return e.mount(null!==(t=this.shadowRoot)&&void 0!==t?t:this,this.getDisposeResult("inline"))})));this.getDisposeResult("shadowDOM")&&this.attachShadow({mode:"open"}),this.handleCreate()}disconnectedCallback(){this.handleUnmount(this.getDisposeResult("destory")),0==--$e.microAppCount&&Ue()}attributeChangedCallback(e,r,i){if(this.legalAttribute(e,i)&&this[e]!==i)if(e!==d.URL||this.url)e!==d.NAME||this.name?this.isWating||(this.isWating=!0,n(this.handleAttributeUpdate)):(this.cacheData&&(ue.setData(i,this.cacheData),this.cacheData=null),this.name=i);else{if(!(i=o(i)))return console.error(t("Invalid attribute url"));this.url=i}}legalAttribute(e,n){return!("string"!=typeof n||!n)||(console.error(t(`unexpected attribute ${e}, please check again`)),!1)}handleCreate(){var e;const t=new he({name:this.name,url:this.url,container:null!==(e=this.shadowRoot)&&void 0!==e?e:this,inline:this.getDisposeResult("inline"),scopecss:!this.getDisposeResult("disableScopecss"),useSandbox:!this.getDisposeResult("disableSandbox"),macro:this.getDisposeResult("macro")});de.set(this.name,t)}handleUnmount(e){const t=de.get(this.name);t&&t.unmount(e)}getDisposeResult(e){return(this.hasAttribute(e)||ue[e])&&"false"!==this.getAttribute(e)}set data(e){this.name?ue.setData(this.name,e):this.cacheData=e}get data(){return this.name?ue.getData(this.name,!0):this.cacheData?this.cacheData:null}}$e.microAppCount=0,customElements.get("micro-app")||customElements.define("micro-app",$e),e.default=ue,e.preFetch=le,e.removeDomScope=function(){a(null)},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.js.map
